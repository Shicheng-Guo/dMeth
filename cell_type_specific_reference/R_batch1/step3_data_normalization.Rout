
R version 3.2.2 (2015-08-14) -- "Fire Safety"
Copyright (C) 2015 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin13.4.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 3.2.5 
> library(ggplot2)
Warning message:
package ‘ggplot2’ was built under R version 3.2.4 
> # library(cowplot)
> 
> fun1 <- function(v, f){
+   tapply(v, f, mean, na.rm=TRUE)
+ }
> 
> # ------------------------------------------------------------
> # read in probe information
> # ------------------------------------------------------------
> 
> setwd("~/research/Deconvolution/data")
> 
> info = fread("i450_filtered_probes.txt")
Read 33.0% of 393401 rowsRead 50.8% of 393401 rowsRead 73.7% of 393401 rowsRead 86.4% of 393401 rowsRead 99.1% of 393401 rowsRead 393401 rows and 37 (of 37) columns from 0.160 GB file in 00:00:07
Warning message:
In fread("i450_filtered_probes.txt") :
  Bumped column 16 to type character on data row 3562, field contains 'MULTI'. Coercing previously read values in this column from logical, integer or numeric back to character which may not be lossless; e.g., if '00' and '000' occurred before they will now be just '0', and there may be inconsistencies with treatment of ',,' and ',NA,' too (if they occurred in this column before the bump). If this matters please rerun and set 'colClasses' to 'character' for this column. Please note that column type detection uses a sample of 1,000 rows (100 rows at 10 points) so hopefully this message should be very rare. If reporting to datatable-help, please rerun and include the output from verbose=TRUE.
> dim(info)
[1] 393401     37
> info[1:2,]
           ID       Name AddressA_ID
1: cg00000029 cg00000029    14782418
2: cg00000165 cg00000165    12637463
                                     AlleleA_ProbeSeq AddressB_ID
1: AACTATACTAACRAAAAAATATCCAAAAAACACTAACRTATAAAAATTTC          NA
2: CAAAATCTATTAATACAATAACTTTTAATAAAACAACTAAAACACACATC          NA
   AlleleB_ProbeSeq Infinium_Design_Type Next_Base Color_Channel
1:                                    II                        
2:                                    II                        
                                                                                                               Forward_Sequence
1: TTTTTTAGATAAGGATATCCAGGCGATGAGGAAGTTTTACTTCTGGGAACAGCCTGGATA[CG]AAACCTTCACACGTCAGTGTCTTTTGGACATTTTCTCGTCAGTACAGCCCTGTTGAATGT
2: CTAAGTGCAGTCAGGATCTGTTAGTACAGTGGCTTTTGATGGAACAGCTGAGGCACACAT[CG]CCCGTGGCATGGACTCCGGGGCCGAACGCTCACGACCAAGACTTTTGCCCTTTTGAAATG
   Genome_Build CHR  MAPINFO                                          SourceSeq
1:           37  16 53468112 GCTGTACTGACGAGAAAATGTCCAAAAGACACTGACGTGTGAAGGTTTCG
2:           37   1 91194674 AGGATCTGTTAGTACAGTGGCTTTTGATGGAACAGCTGAGGCACACATCG
   Chromosome_36 Coordinate_36 Strand Probe_SNPs Probe_SNPs_10 Random_Loci
1:            16      52025613      F         NA            NA          NA
2:             1      90967262      R         NA            NA          NA
   Methyl27_Loci UCSC_RefGene_Name UCSC_RefGene_Accession UCSC_RefGene_Group
1:            NA              RBL2              NM_005611            TSS1500
2:            NA                                                            
     UCSC_CpG_Islands_Name Relation_to_UCSC_CpG_Island Phantom  DMR Enhancer
1: chr16:53468284-53469209                     N_Shore                    NA
2:  chr1:91190489-91192804                     S_Shore         CDMR     TRUE
            HMM_Island Regulatory_Feature_Name Regulatory_Feature_Group  DHS
1:                        16:53467838-53469685      Promoter_Associated TRUE
2: 1:90967262-90967361                                                    NA
   RANGE_START RANGE_END     RANGE_GB SPOT_ID
1:    53468112  53468235  NC_000016.9      NA
2:    91194674  91194797 NC_000001.10      NA
> 
> info = info[,-c(3:6,10,14)]
> dim(info)
[1] 393401     31
> info[1:2,]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg00000029 cg00000029                   II                        
2: cg00000165 cg00000165                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37  16 53468112            16      52025613      F         NA
2:           37   1 91194674             1      90967262      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci UCSC_RefGene_Name
1:            NA          NA            NA              RBL2
2:            NA          NA            NA                  
   UCSC_RefGene_Accession UCSC_RefGene_Group   UCSC_CpG_Islands_Name
1:              NM_005611            TSS1500 chr16:53468284-53469209
2:                                            chr1:91190489-91192804
   Relation_to_UCSC_CpG_Island Phantom  DMR Enhancer          HMM_Island
1:                     N_Shore                    NA                    
2:                     S_Shore         CDMR     TRUE 1:90967262-90967361
   Regulatory_Feature_Name Regulatory_Feature_Group  DHS RANGE_START RANGE_END
1:    16:53467838-53469685      Promoter_Associated TRUE    53468112  53468235
2:                                                    NA    91194674  91194797
       RANGE_GB SPOT_ID
1:  NC_000016.9      NA
2: NC_000001.10      NA
> 
> g1 = grep("FOXP3", info$UCSC_RefGene_Name)
> info[g1,]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg01905377 cg01905377                   II                        
2: cg02033323 cg02033323                   II                        
3: cg04920616 cg04920616                   II                        
4: cg06767008 cg06767008                   II                        
5: cg08884343 cg08884343                   II                        
6: cg10858077 cg10858077                   II                        
7: cg15614573 cg15614573                   II                        
8: cg16350494 cg16350494                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37   X 49122718             X      49009662      R         NA
2:           37   X 49118313             X      49005257      R         NA
3:           37   X 49121288             X      49008232      R         NA
4:           37   X 49114545             X      49001489      R         NA
5:           37   X 49122423             X      49009367      R         NA
6:           37   X 49121205             X      49008149      R         NA
7:           37   X 49122364             X      49009308      F         NA
8:           37   X 49121910             X      49008854      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci       UCSC_RefGene_Name
1:            NA          NA            NA             FOXP3;FOXP3
2:            NA          NA            NA             FOXP3;FOXP3
3:            NA          NA          TRUE             FOXP3;FOXP3
4:            NA          NA            NA             FOXP3;FOXP3
5:            NA          NA          TRUE             FOXP3;FOXP3
6:            NA          NA            NA FOXP3;FOXP3;FOXP3;FOXP3
7:            NA          NA            NA             FOXP3;FOXP3
8:            NA          NA            NA             FOXP3;FOXP3
                          UCSC_RefGene_Accession          UCSC_RefGene_Group
1:                        NM_014009;NM_001114377             TSS1500;TSS1500
2:                        NM_014009;NM_001114377                 5'UTR;5'UTR
3:                        NM_014009;NM_001114377               TSS200;TSS200
4:                        NM_014009;NM_001114377                   Body;Body
5:                        NM_014009;NM_001114377             TSS1500;TSS1500
6: NM_001114377;NM_014009;NM_014009;NM_001114377 1stExon;5'UTR;1stExon;5'UTR
7:                        NM_014009;NM_001114377             TSS1500;TSS1500
8:                        NM_014009;NM_001114377             TSS1500;TSS1500
    UCSC_CpG_Islands_Name Relation_to_UCSC_CpG_Island Phantom DMR Enhancer
1: chrX:49125645-49127200                     N_Shelf                   NA
2:                                                                      NA
3:                                                                      NA
4:                                                                      NA
5: chrX:49125645-49127200                     N_Shelf                   NA
6:                                                                      NA
7: chrX:49125645-49127200                     N_Shelf                   NA
8: chrX:49125645-49127200                     N_Shelf                   NA
   HMM_Island Regulatory_Feature_Name        Regulatory_Feature_Group DHS
1:                                                                     NA
2:                                                                     NA
3:                                                                     NA
4:                X:49114410-49114805 Unclassified_Cell_type_specific  NA
5:                                                                     NA
6:                                                                     NA
7:                                                                     NA
8:                                                                     NA
   RANGE_START RANGE_END     RANGE_GB SPOT_ID
1:    49122718  49122841 NC_000023.10      NA
2:    49118313  49118436 NC_000023.10      NA
3:    49121288  49121411 NC_000023.10      NA
4:    49114545  49114668 NC_000023.10      NA
5:    49122423  49122546 NC_000023.10      NA
6:    49121205  49121328 NC_000023.10      NA
7:    49122364  49122487 NC_000023.10      NA
8:    49121910  49122033 NC_000023.10      NA
> 
> Foxp3 = info$ID[g1]
> Foxp3
[1] "cg01905377" "cg02033323" "cg04920616" "cg06767008" "cg08884343"
[6] "cg10858077" "cg15614573" "cg16350494"
> 
> # ------------------------------------------------------------
> # read in data
> # ------------------------------------------------------------
> 
> sam.Reinius = fread("Reinius_methy_samples.txt")
> dat.Reinius = fread("Reinius_methy_data.txt")
Read 40.7% of 393401 rowsRead 91.5% of 393401 rowsRead 393401 rows and 61 (of 61) columns from 0.227 GB file in 00:00:04
> 
> dim(dat.Reinius)
[1] 393401     61
> dat.Reinius[1:3,1:5]
           id GSM861635 GSM861636 GSM861637 GSM861638
1: cg00000029 0.5413522 0.4889614 0.5140406 0.5423428
2: cg00000165 0.2204557 0.1613999 0.1826917 0.1668749
3: cg00000236 0.8289168 0.7181840 0.7489113 0.7585201
> 
> dim(sam.Reinius)
[1] 60  2
> sam.Reinius[1:3,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
3: GSM861637 Whole blood
> table(sam.Reinius$label)

CD14+ Monocytes   CD19+ B cells    CD4+ T cells  CD56+ NK cells    CD8+ T cells 
              6               6               6               6               6 
    Eosinophils    Granulocytes     Neutrophils            PBMC     Whole blood 
              6               6               6               6               6 
> 
> nNA.R = rowSums(is.na(dat.Reinius))
> table(nNA.R)
nNA.R
     0      1      2      3      4      5      6      7      8      9     10 
372220  18612   1962    377    100     43     22     10     12      8      4 
    11     12     13     14     15     18     19     20     21     24     25 
     2     10      1      2      2      3      1      2      1      1      2 
    27     29 
     2      2 
> 
> dat.Reinius = dat.Reinius[which(nNA.R <= 2),]
> dim(dat.Reinius)
[1] 392794     61
> dat.Reinius[1:3,1:5]
           id GSM861635 GSM861636 GSM861637 GSM861638
1: cg00000029 0.5413522 0.4889614 0.5140406 0.5423428
2: cg00000165 0.2204557 0.1613999 0.1826917 0.1668749
3: cg00000236 0.8289168 0.7181840 0.7489113 0.7585201
> 
> table(sam.Reinius$label)

CD14+ Monocytes   CD19+ B cells    CD4+ T cells  CD56+ NK cells    CD8+ T cells 
              6               6               6               6               6 
    Eosinophils    Granulocytes     Neutrophils            PBMC     Whole blood 
              6               6               6               6               6 
> ctMeans = t(apply(dat.Reinius[,-1,with=FALSE], 1, fun1, f=sam.Reinius$label))
> dim(ctMeans)
[1] 392794     10
> ctMeans[1:2,]
     CD14+ Monocytes CD19+ B cells CD4+ T cells CD56+ NK cells CD8+ T cells
[1,]       0.4530074     0.6417679    0.6904715      0.6683803    0.7502294
[2,]       0.1577738     0.1980824    0.2081959      0.2045046    0.2338493
     Eosinophils Granulocytes Neutrophils      PBMC Whole blood
[1,]   0.2731633    0.4241115   0.4231043 0.6051705   0.5133555
[2,]   0.1696632    0.1704070   0.1706592 0.2009293   0.1700657
> 
> ww1 = which(is.na(dat.Reinius), arr.ind=TRUE)
> dim(ww1)
[1] 22536     2
> ww1[1:5,]
      row col
[1,]  180   2
[2,]  613   2
[3,] 1334   2
[4,] 2738   2
[5,] 2835   2
> 
> for(i in 1:nrow(ww1)){
+   if(i %% 5000 == 0){ cat(i, date(), "\n") }
+   rid = ww1[i,1]
+   cid = ww1[i,2]
+   
+   mati = which(colnames(ctMeans) == sam.Reinius$label[cid-1])
+   dat.Reinius[[cid]][rid] = ctMeans[rid,mati]
+ }
5000 Wed Feb 15 21:49:00 2017 
10000 Wed Feb 15 21:49:11 2017 
15000 Wed Feb 15 21:49:22 2017 
20000 Wed Feb 15 21:49:33 2017 
> 
> table(Foxp3 %in% dat.Reinius$id)

TRUE 
   8 
> mat1 = match(dat.Reinius$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38104 19480 23463 20003  9809 12177 12456 17641 22778  4782 20902 28180  8251 
   21    22     3     4     5     6     7     8     9     X     Y 
 3328  6908 20737 16324 19778 28457 23895 16792  8003 10156   390 
> 
> # ------------------------------------------------------------
> # CD4T_CD8T_E-GEOD-71957
> # ------------------------------------------------------------
> 
> dat.Limbach = fread("CD4T_CD8T_E-GEOD-71957_methy_data.txt")
Read 48.9% of 327469 rowsRead 91.6% of 327469 rowsRead 327469 rows and 63 (of 63) columns from 0.345 GB file in 00:00:04
> dim(dat.Limbach)
[1] 327469     63
> dat.Limbach[1:2,1:5]
           id GSM1848097 GSM1848096 GSM1848095 GSM1848094
1: cg00000029  0.6500930  0.6878452  0.6075558  0.6736537
2: cg00000165  0.2606096  0.2564694  0.2985161  0.3168454
> 
> sam.Limbach = fread("CD4T_CD8T_E-GEOD-71957_methy_sample.txt")
> dim(sam.Limbach)
[1] 62 12
> sam.Limbach[1:2,]
    Source_Name                      Sample_source_name           Sample_title
1: GSM1848097 1 Genomic DNA, CD8 cells, healthy control gDNA_CD8_Control_rep31
2: GSM1848096 1 Genomic DNA, CD8 cells, healthy control gDNA_CD8_Control_rep30
   age   cell_type diagonsis1 organism_part    sex Material_Type Assay_Name
1:  71 CD8 T cells    Healthy         blood female   genomic DNA GSM1848097
2:  71 CD8 T cells    Healthy         blood female   genomic DNA GSM1848096
   Array_Design_REF     Derived_Array_Data_File
1:     A-GEOD-13534 GSM1848097_sample_table.txt
2:     A-GEOD-13534 GSM1848096_sample_table.txt
> table(sam.Limbach$cell_type)

CD4 T cells CD8 T cells 
         31          31 
> 
> nNA.R = rowSums(is.na(dat.Limbach))
> table(nNA.R)
nNA.R
     0     31 
325517   1952 
> 
> dim(dat.Limbach)
[1] 327469     63
> dat.Limbach = dat.Limbach[which(nNA.R <= 2),]
> dim(dat.Limbach)
[1] 325517     63
> dat.Limbach[1:3,1:5]
           id GSM1848097 GSM1848096 GSM1848095 GSM1848094
1: cg00000029  0.6500930  0.6878452  0.6075558  0.6736537
2: cg00000165  0.2606096  0.2564694  0.2985161  0.3168454
3: cg00000236  0.8135846  0.8334806  0.8377063  0.8676201
> 
> nNA.R = rowSums(is.na(dat.Limbach))
> table(nNA.R)
nNA.R
     0 
325517 
> 
> table(Foxp3 %in% dat.Limbach$id)

TRUE 
   8 
> mat1 = match(dat.Limbach$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
31783 16023 19675 16735  8033 10121 10152 14246 19111  4137 17624 23370  7169 
   21    22     3     4     5     6     7     8     9     X     Y 
 2775  5670 17365 13426 16284 23513 19110 13627  6724  8827    17 
> 
> # ------------------------------------------------------------
> # mono_CD4T_E-GEOD-56047, read in sample information
> # ------------------------------------------------------------
> 
> sam.Reynolds = fread("mono_CD4T_E-GEOD-56047_methy_sample.txt")
> dim(sam.Reynolds)
[1] 1416   17
> sam.Reynolds[1:2,]
    Source_Name Sample_source_name                        Sample_title age_yrs
1: GSM1364650 1          CD4+ cell 101264_peripheral_CD4 [methylation]      56
2: GSM1364649 1          CD4+ cell 101261_peripheral_CD4 [methylation]      64
        bcell      mono     neutro     nkcell tcell racegendersite well well_id
1: 0.07666084 0.2519857 0.02330508 0.04006678    NA              1   NA  R05C02
2: 0.30368592 0.3579959 0.06856712 0.01598819    NA              4   NA  R06C01
   Material_Type Assay_Name Array_Design_REF Derived_Array_Data_File  altID
1:   genomic DNA GSM1364650     A-GEOD-13534                      NA 101264
2:   genomic DNA GSM1364649     A-GEOD-13534                      NA 101261
> 
> apply(sam.Reynolds[,5:9], 2, summary)
$bcell
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.001192 0.070800 0.093290 0.113800 0.126200 0.619700 

$mono
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
 0.0734  0.2412  0.2950  0.2859  0.3267  0.5335    1202 

$neutro
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.000642 0.163900 0.206300 0.189800 0.236000 0.406900 

$nkcell
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0008666 0.0537600 0.1066000 0.1133000 0.1650000 0.4795000 

$tcell
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
0.00000 0.00186 0.01709 0.08393 0.14100 0.50980     214 

> 
> length(unique(sam.Reynolds$altID))
[1] 1202
> table(table(sam.Reynolds$altID))

  1   2 
988 214 
> 
> table(sam.Reynolds$well_id)

R01C01 R01C02 R02C01 R02C02 R03C01 R03C02 R04C01 R04C02 R05C01 R05C02 R06C01 
   123    110    119    124    107    125    117    114    115    120    120 
R06C02 
   122 
> table(sam.Reynolds$Sample_source_name)

CD14+ cell  CD4+ cell 
      1202        214 
> table(sam.Reynolds$Sample_source_name, sam.Reynolds$well_id)
            
             R01C01 R01C02 R02C01 R02C02 R03C01 R03C02 R04C01 R04C02 R05C01
  CD14+ cell    101     95    100    107     93    104    101     92     99
  CD4+ cell      22     15     19     17     14     21     16     22     16
            
             R05C02 R06C01 R06C02
  CD14+ cell    100    104    106
  CD4+ cell      20     16     16
> 
> ww1 = which(sam.Reynolds$Sample_source_name == "CD4+ cell")
> sam.Reynolds.CD4  = sam.Reynolds[ww1]
> sam.Reynolds.mono = sam.Reynolds[-ww1]
> 
> apply(sam.Reynolds.CD4[,5:9], 2, summary)
$bcell
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.008552 0.111200 0.155500 0.164100 0.219200 0.552300 

$mono
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.07342 0.24120 0.29500 0.28590 0.32670 0.53350 

$neutro
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.000642 0.021880 0.037810 0.047230 0.059870 0.201800 

$nkcell
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.001092 0.012730 0.025430 0.044510 0.051980 0.479500 

$tcell
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
     NA      NA      NA     NaN      NA      NA     214 

> apply(sam.Reynolds.mono[,5:9], 2, summary)
$bcell
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.001192 0.068300 0.089340 0.104800 0.113100 0.619700 

$mono
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
     NA      NA      NA     NaN      NA      NA    1202 

$neutro
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.06421 0.18800 0.21540 0.21510 0.24130 0.40690 

$nkcell
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0008666 0.0703400 0.1196000 0.1255000 0.1728000 0.4634000 

$tcell
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.000000 0.001856 0.017090 0.083930 0.141000 0.509800 

> 
> max.CD4 = apply(sam.Reynolds.CD4[,5:9], 1, max, na.rm = TRUE)
> summary(max.CD4)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.07342 0.24490 0.29660 0.29040 0.32880 0.55230 
> table(max.CD4 < 0.2)

FALSE  TRUE 
  191    23 
> 
> max.CD14 = apply(sam.Reynolds.mono[,5:9], 1, max, na.rm = TRUE)
> summary(max.CD14)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.07475 0.20250 0.23160 0.24250 0.26700 0.61970 
> table(max.CD14 < 0.15)

FALSE  TRUE 
 1168    34 
> 
> sam.Reynolds.CD4 = sam.Reynolds.CD4[which(max.CD4 < 0.2),]
> dim(sam.Reynolds.CD4)
[1] 23 17
> sam.Reynolds.CD4[1:2,]
    Source_Name Sample_source_name                        Sample_title age_yrs
1: GSM1364563 1          CD4+ cell 100787_peripheral_CD4 [methylation]      58
2: GSM1364558 1          CD4+ cell 100760_peripheral_CD4 [methylation]      49
        bcell       mono     neutro     nkcell tcell racegendersite well
1: 0.09102415 0.16696359 0.03787879 0.01823552    NA             14   NA
2: 0.04879370 0.07341509 0.04256549 0.02144600    NA             14   NA
   well_id Material_Type Assay_Name Array_Design_REF Derived_Array_Data_File
1:  R04C02   genomic DNA GSM1364563     A-GEOD-13534                      NA
2:  R04C02   genomic DNA GSM1364558     A-GEOD-13534                      NA
    altID
1: 100787
2: 100760
> 
> sam.Reynolds.mono = sam.Reynolds.mono[which(max.CD14 < 0.15),]
> dim(sam.Reynolds.mono)
[1] 34 17
> sam.Reynolds.mono[1:2,]
    Source_Name Sample_source_name                         Sample_title age_yrs
1: GSM1354359 1         CD14+ cell 101217_peripheral_CD14 [methylation]      61
2: GSM1354339 1         CD14+ cell 101197_peripheral_CD14 [methylation]      57
        bcell mono    neutro     nkcell        tcell racegendersite well
1: 0.04880812   NA 0.1448514 0.07219845 0.0002709146              4   NA
2: 0.04619042   NA 0.1386952 0.03846062 0.0222691808             16   NA
   well_id Material_Type Assay_Name Array_Design_REF Derived_Array_Data_File
1:  R03C02   genomic DNA GSM1354359     A-GEOD-13534                      NA
2:  R05C02   genomic DNA GSM1354339     A-GEOD-13534                      NA
    altID
1: 101217
2: 101197
> 
> # ------------------------------------------------------------
> # CD4T data
> # ------------------------------------------------------------
> 
> dat.Reynolds.CD4 = fread("CD4T_E-GEOD-56047_methy_data.txt")
Read 2.5% of 393401 rowsRead 17.8% of 393401 rowsRead 33.0% of 393401 rowsRead 48.3% of 393401 rowsRead 63.5% of 393401 rowsRead 78.8% of 393401 rowsRead 94.1% of 393401 rowsRead 393401 rows and 215 (of 215) columns from 0.814 GB file in 00:00:10
> dim(dat.Reynolds.CD4)
[1] 393401    215
> dat.Reynolds.CD4[1:2,1:5]
       ID_REF GSM1364437 GSM1364438 GSM1364439 GSM1364440
1: cg00000029   1.262545   1.139552   1.061584   1.144077
2: cg00000165  -1.388749  -1.353385  -1.325551  -1.252946
> 
> mat1 = match(sam.Reynolds.CD4$Assay_Name, names(dat.Reynolds.CD4))
> dat.Reynolds.CD4 = dat.Reynolds.CD4[,c(1,mat1),with=FALSE]
> dim(dat.Reynolds.CD4)
[1] 393401     24
> dat.Reynolds.CD4[1:2,1:5]
       ID_REF GSM1364563 GSM1364558 GSM1364556 GSM1364555
1: cg00000029  0.8849583   1.173040   1.126292   1.141015
2: cg00000165 -1.4624901  -1.205331  -1.312404  -1.294494
> 
> table(names(dat.Reynolds.CD4)[-1] == sam.Reynolds.CD4$Assay_Name)

TRUE 
  23 
> 
> summary(dat.Reynolds.CD4[[2]])
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-5.97900 -2.78200  0.87180  0.08334  2.62400  6.10400 
> 
> for(k in 2:ncol(dat.Reynolds.CD4)){
+   nmk = names(dat.Reynolds.CD4)[k]
+   dat.Reynolds.CD4[[nmk]] = exp(dat.Reynolds.CD4[[nmk]])/(1 + exp(dat.Reynolds.CD4[[nmk]]))
+ }
> summary(dat.Reynolds.CD4[[2]])
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.002524 0.058320 0.705100 0.536500 0.932400 0.997800 
> 
> nNA.R = rowSums(is.na(dat.Reynolds.CD4))
> table(nNA.R)
nNA.R
     0 
393401 
> 
> names(dat.Reynolds.CD4)[1] = "id"
> table(Foxp3 %in% dat.Reynolds.CD4$id)

TRUE 
   8 
> mat1 = match(dat.Reynolds.CD4$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38167 19523 23499 20031  9823 12202 12479 17662 22814  4793 20929 28217  8266 
   21    22     3     4     5     6     7     8     9     X     Y 
 3335  6922 20765 16348 19798 28504 23939 16813  8012 10169   391 
> 
> # ------------------------------------------------------------
> # mono data
> # ------------------------------------------------------------
> 
> dat.Reynolds.mono = fread("CD14T_E-GEOD-56047_methy_data.txt")
Read 0.0% of 393401 rowsRead 2.5% of 393401 rowsRead 5.1% of 393401 rowsRead 7.6% of 393401 rowsRead 10.2% of 393401 rowsRead 12.7% of 393401 rowsRead 15.3% of 393401 rowsRead 17.8% of 393401 rowsRead 20.3% of 393401 rowsRead 22.9% of 393401 rowsRead 28.0% of 393401 rowsRead 30.5% of 393401 rowsRead 33.0% of 393401 rowsRead 35.6% of 393401 rowsRead 38.1% of 393401 rowsRead 40.7% of 393401 rowsRead 43.2% of 393401 rowsRead 45.8% of 393401 rowsRead 48.3% of 393401 rowsRead 50.8% of 393401 rowsRead 53.4% of 393401 rowsRead 55.9% of 393401 rowsRead 58.5% of 393401 rowsRead 61.0% of 393401 rowsRead 63.5% of 393401 rowsRead 66.1% of 393401 rowsRead 68.6% of 393401 rowsRead 71.2% of 393401 rowsRead 73.7% of 393401 rowsRead 76.3% of 393401 rowsRead 78.8% of 393401 rowsRead 81.3% of 393401 rowsRead 83.9% of 393401 rowsRead 86.4% of 393401 rowsRead 89.0% of 393401 rowsRead 91.5% of 393401 rowsRead 94.1% of 393401 rowsRead 96.6% of 393401 rowsRead 99.1% of 393401 rowsRead 393401 rows and 1203 (of 1203) columns from 4.561 GB file in 00:00:55
> dim(dat.Reynolds.mono)
[1] 393401   1203
> dat.Reynolds.mono[1:2,1:5]
       ID_REF GSM1353204 GSM1353205 GSM1353206 GSM1353207
1: cg00000029 -0.2482799 -0.0203916 -0.3737213 -0.2371848
2: cg00000165 -2.0308491 -1.4621109 -1.4642360 -1.5692278
> 
> mat1 = match(sam.Reynolds.mono$Assay_Name, names(dat.Reynolds.mono))
> dat.Reynolds.mono = dat.Reynolds.mono[,c(1,mat1),with=FALSE]
> dim(dat.Reynolds.mono)
[1] 393401     35
> dat.Reynolds.mono[1:2,1:5]
       ID_REF GSM1354359 GSM1354339 GSM1354305 GSM1354290
1: cg00000029   0.154205  0.0191623  0.4188111 -0.2424014
2: cg00000165  -1.805507 -1.8832329 -1.5142005 -2.0910993
> 
> table(names(dat.Reynolds.mono)[-1] == sam.Reynolds.mono$Assay_Name)

TRUE 
  34 
> 
> summary(dat.Reynolds.mono[[2]])
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-6.5920 -2.9960  0.8176  0.0623  2.8440  6.9590 
> for(k in 2:ncol(dat.Reynolds.mono)){
+   nmk = names(dat.Reynolds.mono)[k]
+   dat.Reynolds.mono[[nmk]] = exp(dat.Reynolds.mono[[nmk]])/(1 + exp(dat.Reynolds.mono[[nmk]]))
+ }
> summary(dat.Reynolds.mono[[2]])
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.001369 0.047620 0.693700 0.529700 0.945000 0.999100 
> 
> nNA.R = rowSums(is.na(dat.Reynolds.mono))
> table(nNA.R)
nNA.R
     0 
393401 
> 
> names(dat.Reynolds.mono)[1] = "id"
> table(Foxp3 %in% dat.Reynolds.mono$id)

TRUE 
   8 
> mat1 = match(dat.Reynolds.mono$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38167 19523 23499 20031  9823 12202 12479 17662 22814  4793 20929 28217  8266 
   21    22     3     4     5     6     7     8     9     X     Y 
 3335  6922 20765 16348 19798 28504 23939 16813  8012 10169   391 
> 
> # ------------------------------------------------------------
> # mono_DC_MAC_E-GEOD-71837
> # ------------------------------------------------------------
> 
> dat.Vento = fread("mono_DC_MAC_E-GEOD-71837_methy_data.txt")
> dim(dat.Vento)
[1] 393401     10
> dat.Vento[1:2,1:5]
           id GSM1846592 GSM1846591 GSM1846590 GSM1846586
1: cg00000029  0.7423225  0.6915279  0.7677006  0.7079468
2: cg00000165  0.6678801  0.5308191  0.6252498  0.5737686
> 
> sam.Vento = fread("mono_DC_MAC_E-GEOD-71837_methy_sample.txt")
> dim(sam.Vento)
[1] 9 9
> sam.Vento[1:2,]
    Source_Name             Sample_source_name Sample_title
1: GSM1846592 1 iMAC treated with LPS for 24 h mMAC_donor 3
2: GSM1846591 1 iMAC treated with LPS for 24 h mMAC_donor 2
               cell_type donor_id treated_with Material_Type Assay_Name
1: activated/mature MACs  donor 3 LPS for 24 h   genomic DNA GSM1846592
2: activated/mature MACs  donor 2 LPS for 24 h   genomic DNA GSM1846591
       Derived_Array_Data_File
1: GSM1846592_sample_table.txt
2: GSM1846591_sample_table.txt
> table(sam.Vento$cell_type)

                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
> 
> nNA.R = rowSums(is.na(dat.Vento))
> table(nNA.R)
nNA.R
     0      1      2      3      4      5      6      8 
392934    120     92    236      7      9      2      1 
> 
> dim(dat.Vento)
[1] 393401     10
> dat.Vento = dat.Vento[which(nNA.R <= 1),]
> dim(dat.Vento)
[1] 393054     10
> dat.Vento[1:3,1:5]
           id GSM1846592 GSM1846591 GSM1846590 GSM1846586
1: cg00000029  0.7423225  0.6915279  0.7677006  0.7079468
2: cg00000165  0.6678801  0.5308191  0.6252498  0.5737686
3: cg00000236  0.9182523  0.9140009  0.9003964  0.8934854
> 
> table(sam.Vento$cell_type)

                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
> ctMeans = t(apply(dat.Vento[,-1,with=FALSE], 1, fun1, f=sam.Vento$cell_type))
> dim(ctMeans)
[1] 393054      3
> ctMeans[1:2,]
     activated/mature DCs activated/mature MACs
[1,]            0.7648708             0.7338503
[2,]            0.5975752             0.6079830
     peripheral blood isolated CD14+ cells (monocytes)
[1,]                                         0.7937250
[2,]                                         0.6213118
> 
> ww1 = which(is.na(dat.Vento), arr.ind=TRUE)
> dim(ww1)
[1] 120   2
> ww1[1:5,]
       row col
[1,] 18082   2
[2,] 19347   2
[3,] 28601   2
[4,] 49664   2
[5,] 54117   2
> 
> for(i in 1:nrow(ww1)){
+   rid = ww1[i,1]
+   cid = ww1[i,2]
+   
+   mati = which(colnames(ctMeans) == sam.Vento$cell_type[cid-1])
+   dat.Vento[[cid]][rid] = ctMeans[rid,mati]
+ }
> 
> nNA.R = rowSums(is.na(dat.Vento))
> table(nNA.R)
nNA.R
     0 
393054 
> 
> table(Foxp3 %in% dat.Vento$id)

TRUE 
   8 
> mat1 = match(dat.Vento$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38163 19518 23498 20031  9822 12202 12478 17661 22811  4792 20924 28215  8266 
   21    22     3     4     5     6     7     8     9     X     Y 
 3335  6912 20764 16346 19785 28494 23936 16808  8012 10163   118 
> 
> # ------------------------------------------------------------
> # neut_E-GEOD-65097_methy_data.txt
> # ------------------------------------------------------------
> 
> dat.Coit = fread("neut_E-GEOD-65097_methy_data.txt")
> dim(dat.Coit)
[1] 393401     16
> dat.Coit[1:2,1:5]
           id GSM1587293 GSM1587292 GSM1587289 GSM1587288
1: cg00000029  0.4619165  0.4832633  0.3962995  0.3925624
2: cg00000165  0.1576691  0.1497034  0.1347503  0.1365024
> 
> sam.Coit = fread("neut_E-GEOD-65097_methy_sample.txt")
> dim(sam.Coit)
[1] 15 10
> sam.Coit[1:2,]
    Source_Name Sample_source_name                         Sample_title    Sex
1: GSM1587293 1        neutrophils neutrophils isolated from control 15 female
2: GSM1587292 1        neutrophils neutrophils isolated from control 12 female
   age          cell_type disease_state Material_Type Assay_Name
1:  47 normal neutrophils       control   genomic DNA GSM1587293
2:  46 normal neutrophils       control   genomic DNA GSM1587292
       Derived_Array_Data_File
1: GSM1587293_sample_table.txt
2: GSM1587292_sample_table.txt
> table(sam.Coit$cell_type)

normal neutrophils 
                15 
> 
> nNA.R = rowSums(is.na(dat.Coit))
> table(nNA.R)
nNA.R
     0      1      2      3      4      5      6      7      8      9 
387556   5495    239     51     32     12      2      8      2      4 
> 
> dim(dat.Coit)
[1] 393401     16
> dat.Coit = dat.Coit[which(nNA.R <= 3),]
> dim(dat.Coit)
[1] 393341     16
> dat.Coit[1:3,1:5]
           id GSM1587293 GSM1587292 GSM1587289 GSM1587288
1: cg00000029  0.4619165  0.4832633  0.3962995  0.3925624
2: cg00000165  0.1576691  0.1497034  0.1347503  0.1365024
3: cg00000236  0.6146188  0.6276866  0.6391801  0.6146957
> 
> table(sam.Coit$cell_type)

normal neutrophils 
                15 
> ctMeans = rowMeans(dat.Coit[,-1,with=FALSE], na.rm=TRUE)
> length(ctMeans)
[1] 393341
> ctMeans[1:5]
[1] 0.4268123 0.1716360 0.6419155 0.5836832 0.2790715
> 
> ww1 = which(is.na(dat.Coit), arr.ind=TRUE)
> dim(ww1)
[1] 6126    2
> ww1[1:5,]
       row col
[1,]  1843   2
[2,]  2841   2
[3,]  5507   2
[4,]  9427   2
[5,] 10166   2
> 
> for(i in 1:nrow(ww1)){
+   rid = ww1[i,1]
+   cid = ww1[i,2]
+   
+   dat.Coit[[cid]][rid] = ctMeans[rid]
+ }
> 
> nNA.R = rowSums(is.na(dat.Coit))
> table(nNA.R)
nNA.R
     0 
393341 
> 
> table(Foxp3 %in% dat.Coit$id)

TRUE 
   8 
> mat1 = match(dat.Coit$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38162 19523 23497 20027  9821 12200 12478 17656 22808  4793 20925 28213  8264 
   21    22     3     4     5     6     7     8     9     X     Y 
 3334  6921 20760 16346 19796 28498 23935 16812  8012 10169   391 
> 
> # ------------------------------------------------------------
> # NK_E-GEOD-66562_methy_data.txt
> # there is no informtion on chrX or chrY
> # ------------------------------------------------------------
> 
> dat.Schlums = fread("NK_E-GEOD-66562_methy_data.txt")
> dim(dat.Schlums)
[1] 355805     16
> dat.Schlums[1:2,1:5]
           id GSM1625014 GSM1625013 GSM1625012 GSM1625010
1: cg00000029  0.6532010  0.8814443  0.6962613  0.7888444
2: cg00000165  0.1370417  0.4798787  0.1126518  0.1240616
> 
> sam.Schlums = fread("NK_E-GEOD-66562_methy_sample.txt")
> dim(sam.Schlums)
[1] 15 11
> sam.Schlums[1:2,]
    Source_Name                     Sample_source_name
1: GSM1625014 1      CD3-CD56+CD57- canonical NK cells
2: GSM1625013 1 CD3-CD56+CD57+EAT-2- adaptive NK cells
                                                      Sample_title
1:      genomic DNA from Donor 4 CD3-CD56+CD57- canonical NK cells
2: genomic DNA from Donor 4 CD3-CD56+CD57+EAT-2- adaptive NK cells
                                cell_type donor_id           donor_status
1:      CD3-CD56+CD57- canonical NK cells  donor 4 CMV seropositive donor
2: CD3-CD56+CD57+EAT-2- adaptive NK cells  donor 4 CMV seropositive donor
      organism_part Material_Type Assay_Name Array_Design_REF
1: Peripheral Blood   genomic DNA GSM1625014     A-GEOD-13534
2: Peripheral Blood   genomic DNA GSM1625013     A-GEOD-13534
       Derived_Array_Data_File
1: GSM1625014_sample_table.txt
2: GSM1625013_sample_table.txt
> table(sam.Schlums$cell_type)

       CD3-CD56+CD57- canonical NK cells 
                                       4 
  CD3-CD56+CD57+EAT-2- adaptive NK cells 
                                       4 
 CD3-CD56+CD57+EAT-2+ canonical NK cells 
                                       3 
CD3-CD56+CD57+EAT-2int adaptive NK cells 
                                       1 
     CD3-CD56+CD57dim canonical NK cells 
                                       3 
> 
> nNA.R = rowSums(is.na(dat.Schlums))
> table(nNA.R)
nNA.R
     0 
355805 
> 
> table(Foxp3 %in% dat.Schlums$id)

FALSE 
    8 
> mat1 = match(dat.Schlums$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
35696 18245 22187 18679  9073 11341 11450 16294 21368  4556 19563 26271  7948 
   21    22     3     4     5     6     7     8     9 
 3120  6380 19276 15021 18279 26385 21612 15557  7504 
> 
> # ------------------------------------------------------------
> # Treg_E-GEOD-49667_methy_data.txt
> # ------------------------------------------------------------
> 
> dat.Zhang = fread("Treg_E-GEOD-49667_methy_data.txt")
> dim(dat.Zhang)
[1] 393006      5
> dat.Zhang[1:2,1:5]
           id GSM1204714 GSM1204712 GSM1204710 GSM1204706
1: cg00000029  0.7383157  0.8045520  0.8089875  0.8235851
2: cg00000165  0.2168212  0.1522879  0.2314524  0.1442613
> 
> sam.Zhang = fread("Treg_E-GEOD-49667_methy_sample.txt")
> dim(sam.Zhang)
[1]  4 10
> sam.Zhang[1:2,]
    Source_Name Sample_source_name   Sample_title cell_type disease_state
1: GSM1204714 1          act_rTreg act_rTreg_rep2 act_rTreg        normal
2: GSM1204712 1              rTreg     rTreg_rep2     rTreg        normal
   donor_id  sex Material_Type Assay_Name     Derived_Array_Data_File
1:      M30 male   genomic DNA GSM1204714 GSM1204714_sample_table.txt
2:      M30 male   genomic DNA GSM1204712 GSM1204712_sample_table.txt
> 
> table(sam.Zhang$cell_type)

act_rTreg     rTreg 
        2         2 
> 
> nNA.R = rowSums(is.na(dat.Zhang))
> table(nNA.R)
nNA.R
     0 
393006 
> 
> table(Foxp3 %in% dat.Zhang$id)

TRUE 
   8 
> mat1 = match(dat.Zhang$id, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38140 19510 23476 20016  9817 12178 12467 17650 22791  4792 20917 28191  8264 
   21    22     3     4     5     6     7     8     9     X     Y 
 3334  6904 20747 16328 19776 28465 23903 16793  8009 10147   391 
> 
> # ------------------------------------------------------------
> # collapse sample information
> # ------------------------------------------------------------
> 
> dim(sam.Reinius)
[1] 60  2
> dim(sam.Limbach)
[1] 62 12
> dim(sam.Reynolds.CD4)
[1] 23 17
> dim(sam.Reynolds.mono)
[1] 34 17
> dim(sam.Vento)
[1] 9 9
> dim(sam.Coit)
[1] 15 10
> dim(sam.Zhang)
[1]  4 10
> dim(sam.Schlums)
[1] 15 11
> 
> table(sam.Reinius$id == names(dat.Reinius)[-1])

TRUE 
  60 
> 
> sams.All = sam.Reinius
> studies  = rep("Reinius", nrow(sam.Reinius))
> 
> dim(sams.All)
[1] 60  2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

CD14+ Monocytes   CD19+ B cells    CD4+ T cells  CD56+ NK cells    CD8+ T cells 
              6               6               6               6               6 
    Eosinophils    Granulocytes     Neutrophils            PBMC     Whole blood 
              6               6               6               6               6 
> 
> dim(sam.Limbach)
[1] 62 12
> sam.Limbach[1:2,]
    Source_Name                      Sample_source_name           Sample_title
1: GSM1848097 1 Genomic DNA, CD8 cells, healthy control gDNA_CD8_Control_rep31
2: GSM1848096 1 Genomic DNA, CD8 cells, healthy control gDNA_CD8_Control_rep30
   age   cell_type diagonsis1 organism_part    sex Material_Type Assay_Name
1:  71 CD8 T cells    Healthy         blood female   genomic DNA GSM1848097
2:  71 CD8 T cells    Healthy         blood female   genomic DNA GSM1848096
   Array_Design_REF     Derived_Array_Data_File
1:     A-GEOD-13534 GSM1848097_sample_table.txt
2:     A-GEOD-13534 GSM1848096_sample_table.txt
> table(sam.Limbach$Assay_Name == names(dat.Limbach)[-1])

TRUE 
  62 
> 
> studies  = c(studies, rep("Limbach", nrow(sam.Limbach)))
> 
> sams.All = rbindlist(list(sams.All, sam.Limbach[,.(Assay_Name, cell_type)]))
> dim(sams.All)
[1] 122   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

CD14+ Monocytes   CD19+ B cells     CD4 T cells    CD4+ T cells  CD56+ NK cells 
              6               6              31               6               6 
    CD8 T cells    CD8+ T cells     Eosinophils    Granulocytes     Neutrophils 
             31               6               6               6               6 
           PBMC     Whole blood 
              6               6 
> 
> dim(sam.Reynolds.CD4)
[1] 23 17
> sam.Reynolds.CD4[1:2,]
    Source_Name Sample_source_name                        Sample_title age_yrs
1: GSM1364563 1          CD4+ cell 100787_peripheral_CD4 [methylation]      58
2: GSM1364558 1          CD4+ cell 100760_peripheral_CD4 [methylation]      49
        bcell       mono     neutro     nkcell tcell racegendersite well
1: 0.09102415 0.16696359 0.03787879 0.01823552    NA             14   NA
2: 0.04879370 0.07341509 0.04256549 0.02144600    NA             14   NA
   well_id Material_Type Assay_Name Array_Design_REF Derived_Array_Data_File
1:  R04C02   genomic DNA GSM1364563     A-GEOD-13534                      NA
2:  R04C02   genomic DNA GSM1364558     A-GEOD-13534                      NA
    altID
1: 100787
2: 100760
> table(sam.Reynolds.CD4$Assay_Name == names(dat.Reynolds.CD4)[-1])

TRUE 
  23 
> 
> studies  = c(studies, rep("Reynolds", nrow(sam.Reynolds.CD4)))
> 
> sams.All = rbindlist(list(sams.All, sam.Reynolds.CD4[,.(Assay_Name, Sample_source_name)]))
> dim(sams.All)
[1] 145   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

CD14+ Monocytes   CD19+ B cells     CD4 T cells       CD4+ cell    CD4+ T cells 
              6               6              31              23               6 
 CD56+ NK cells     CD8 T cells    CD8+ T cells     Eosinophils    Granulocytes 
              6              31               6               6               6 
    Neutrophils            PBMC     Whole blood 
              6               6               6 
> 
> dim(sam.Reynolds.mono)
[1] 34 17
> sam.Reynolds.mono[1:2,]
    Source_Name Sample_source_name                         Sample_title age_yrs
1: GSM1354359 1         CD14+ cell 101217_peripheral_CD14 [methylation]      61
2: GSM1354339 1         CD14+ cell 101197_peripheral_CD14 [methylation]      57
        bcell mono    neutro     nkcell        tcell racegendersite well
1: 0.04880812   NA 0.1448514 0.07219845 0.0002709146              4   NA
2: 0.04619042   NA 0.1386952 0.03846062 0.0222691808             16   NA
   well_id Material_Type Assay_Name Array_Design_REF Derived_Array_Data_File
1:  R03C02   genomic DNA GSM1354359     A-GEOD-13534                      NA
2:  R05C02   genomic DNA GSM1354339     A-GEOD-13534                      NA
    altID
1: 101217
2: 101197
> table(sam.Reynolds.mono$Assay_Name == names(dat.Reynolds.mono)[-1])

TRUE 
  34 
> 
> studies  = c(studies, rep("Reynolds", nrow(sam.Reynolds.mono)))
> 
> sams.All = rbindlist(list(sams.All, sam.Reynolds.mono[,.(Assay_Name, Sample_source_name)]))
> dim(sams.All)
[1] 179   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

     CD14+ cell CD14+ Monocytes   CD19+ B cells     CD4 T cells       CD4+ cell 
             34               6               6              31              23 
   CD4+ T cells  CD56+ NK cells     CD8 T cells    CD8+ T cells     Eosinophils 
              6               6              31               6               6 
   Granulocytes     Neutrophils            PBMC     Whole blood 
              6               6               6               6 
> 
> dim(sam.Vento)
[1] 9 9
> sam.Vento[1:2,]
    Source_Name             Sample_source_name Sample_title
1: GSM1846592 1 iMAC treated with LPS for 24 h mMAC_donor 3
2: GSM1846591 1 iMAC treated with LPS for 24 h mMAC_donor 2
               cell_type donor_id treated_with Material_Type Assay_Name
1: activated/mature MACs  donor 3 LPS for 24 h   genomic DNA GSM1846592
2: activated/mature MACs  donor 2 LPS for 24 h   genomic DNA GSM1846591
       Derived_Array_Data_File
1: GSM1846592_sample_table.txt
2: GSM1846591_sample_table.txt
> table(sam.Vento$Assay_Name == names(dat.Vento)[-1])

TRUE 
   9 
> 
> studies  = c(studies, rep("Vento", nrow(sam.Vento)))
> 
> sams.All = rbindlist(list(sams.All, sam.Vento[,.(Assay_Name, cell_type)]))
> dim(sams.All)
[1] 188   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
                                       CD14+ cell 
                                               34 
                                  CD14+ Monocytes 
                                                6 
                                    CD19+ B cells 
                                                6 
                                      CD4 T cells 
                                               31 
                                        CD4+ cell 
                                               23 
                                     CD4+ T cells 
                                                6 
                                   CD56+ NK cells 
                                                6 
                                      CD8 T cells 
                                               31 
                                     CD8+ T cells 
                                                6 
                                      Eosinophils 
                                                6 
                                     Granulocytes 
                                                6 
                                      Neutrophils 
                                                6 
                                             PBMC 
                                                6 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
                                      Whole blood 
                                                6 
> 
> dim(sam.Coit)
[1] 15 10
> sam.Coit[1:2,]
    Source_Name Sample_source_name                         Sample_title    Sex
1: GSM1587293 1        neutrophils neutrophils isolated from control 15 female
2: GSM1587292 1        neutrophils neutrophils isolated from control 12 female
   age          cell_type disease_state Material_Type Assay_Name
1:  47 normal neutrophils       control   genomic DNA GSM1587293
2:  46 normal neutrophils       control   genomic DNA GSM1587292
       Derived_Array_Data_File
1: GSM1587293_sample_table.txt
2: GSM1587292_sample_table.txt
> table(sam.Coit$Assay_Name == names(dat.Coit)[-1])

TRUE 
  15 
> 
> studies  = c(studies, rep("Coit", nrow(sam.Coit)))
> 
> sams.All = rbindlist(list(sams.All, sam.Coit[,.(Assay_Name, cell_type)]))
> dim(sams.All)
[1] 203   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
                                       CD14+ cell 
                                               34 
                                  CD14+ Monocytes 
                                                6 
                                    CD19+ B cells 
                                                6 
                                      CD4 T cells 
                                               31 
                                        CD4+ cell 
                                               23 
                                     CD4+ T cells 
                                                6 
                                   CD56+ NK cells 
                                                6 
                                      CD8 T cells 
                                               31 
                                     CD8+ T cells 
                                                6 
                                      Eosinophils 
                                                6 
                                     Granulocytes 
                                                6 
                                      Neutrophils 
                                                6 
                               normal neutrophils 
                                               15 
                                             PBMC 
                                                6 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
                                      Whole blood 
                                                6 
> 
> dim(sam.Zhang)
[1]  4 10
> sam.Zhang[1:2,]
    Source_Name Sample_source_name   Sample_title cell_type disease_state
1: GSM1204714 1          act_rTreg act_rTreg_rep2 act_rTreg        normal
2: GSM1204712 1              rTreg     rTreg_rep2     rTreg        normal
   donor_id  sex Material_Type Assay_Name     Derived_Array_Data_File
1:      M30 male   genomic DNA GSM1204714 GSM1204714_sample_table.txt
2:      M30 male   genomic DNA GSM1204712 GSM1204712_sample_table.txt
> table(sam.Zhang$Assay_Name == names(dat.Zhang)[-1])

TRUE 
   4 
> 
> studies  = c(studies, rep("Zhang", nrow(sam.Zhang)))
> 
> sams.All = rbindlist(list(sams.All, sam.Zhang[,.(Assay_Name, cell_type)]))
> 
> dim(sam.Schlums)
[1] 15 11
> sam.Schlums[1:2,]
    Source_Name                     Sample_source_name
1: GSM1625014 1      CD3-CD56+CD57- canonical NK cells
2: GSM1625013 1 CD3-CD56+CD57+EAT-2- adaptive NK cells
                                                      Sample_title
1:      genomic DNA from Donor 4 CD3-CD56+CD57- canonical NK cells
2: genomic DNA from Donor 4 CD3-CD56+CD57+EAT-2- adaptive NK cells
                                cell_type donor_id           donor_status
1:      CD3-CD56+CD57- canonical NK cells  donor 4 CMV seropositive donor
2: CD3-CD56+CD57+EAT-2- adaptive NK cells  donor 4 CMV seropositive donor
      organism_part Material_Type Assay_Name Array_Design_REF
1: Peripheral Blood   genomic DNA GSM1625014     A-GEOD-13534
2: Peripheral Blood   genomic DNA GSM1625013     A-GEOD-13534
       Derived_Array_Data_File
1: GSM1625014_sample_table.txt
2: GSM1625013_sample_table.txt
> table(sam.Schlums$Assay_Name == names(dat.Schlums)[-1])

TRUE 
  15 
> 
> studies  = c(studies, rep("Schlums", nrow(sam.Schlums)))
> 
> sams.All = rbindlist(list(sams.All, sam.Schlums[,.(Assay_Name, cell_type)]))
> dim(sams.All)
[1] 222   2
> sams.All[1:2,]
          id       label
1: GSM861635 Whole blood
2: GSM861636 Whole blood
> table(sams.All$label)

                                        act_rTreg 
                                                2 
                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
                                       CD14+ cell 
                                               34 
                                  CD14+ Monocytes 
                                                6 
                                    CD19+ B cells 
                                                6 
                CD3-CD56+CD57- canonical NK cells 
                                                4 
           CD3-CD56+CD57+EAT-2- adaptive NK cells 
                                                4 
          CD3-CD56+CD57+EAT-2+ canonical NK cells 
                                                3 
         CD3-CD56+CD57+EAT-2int adaptive NK cells 
                                                1 
              CD3-CD56+CD57dim canonical NK cells 
                                                3 
                                      CD4 T cells 
                                               31 
                                        CD4+ cell 
                                               23 
                                     CD4+ T cells 
                                                6 
                                   CD56+ NK cells 
                                                6 
                                      CD8 T cells 
                                               31 
                                     CD8+ T cells 
                                                6 
                                      Eosinophils 
                                                6 
                                     Granulocytes 
                                                6 
                                      Neutrophils 
                                                6 
                               normal neutrophils 
                                               15 
                                             PBMC 
                                                6 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
                                            rTreg 
                                                2 
                                      Whole blood 
                                                6 
> 
> sams.All[["study"]] = studies
> dim(sams.All)
[1] 222   3
> sams.All[1:2,]
          id       label   study
1: GSM861635 Whole blood Reinius
2: GSM861636 Whole blood Reinius
> table(sams.All$label)

                                        act_rTreg 
                                                2 
                             activated/mature DCs 
                                                3 
                            activated/mature MACs 
                                                3 
                                       CD14+ cell 
                                               34 
                                  CD14+ Monocytes 
                                                6 
                                    CD19+ B cells 
                                                6 
                CD3-CD56+CD57- canonical NK cells 
                                                4 
           CD3-CD56+CD57+EAT-2- adaptive NK cells 
                                                4 
          CD3-CD56+CD57+EAT-2+ canonical NK cells 
                                                3 
         CD3-CD56+CD57+EAT-2int adaptive NK cells 
                                                1 
              CD3-CD56+CD57dim canonical NK cells 
                                                3 
                                      CD4 T cells 
                                               31 
                                        CD4+ cell 
                                               23 
                                     CD4+ T cells 
                                                6 
                                   CD56+ NK cells 
                                                6 
                                      CD8 T cells 
                                               31 
                                     CD8+ T cells 
                                                6 
                                      Eosinophils 
                                                6 
                                     Granulocytes 
                                                6 
                                      Neutrophils 
                                                6 
                               normal neutrophils 
                                               15 
                                             PBMC 
                                                6 
peripheral blood isolated CD14+ cells (monocytes) 
                                                3 
                                            rTreg 
                                                2 
                                      Whole blood 
                                                6 
> 
> # ------------------------------------------------------------
> # re-name cell types
> # ------------------------------------------------------------
> 
> Tregs = c("act_rTreg", "rTreg")
> sams.All$label[which(sams.All$label %in% Tregs)] = "Treg"
> 
> DCs = c("activated/mature DCs")
> sams.All$label[which(sams.All$label %in% DCs)] = "DC"
> 
> Macrophage = c("activated/mature MACs")
> sams.All$label[which(sams.All$label %in% Macrophage)] = "Macrophage"
> 
> Monocyte = c("CD14+ cell", "CD14+ Monocytes")
> Monocyte = c(Monocyte, "peripheral blood isolated CD14+ cells (monocytes)")
> sams.All$label[which(sams.All$label %in% Monocyte)] = "Monocyte"
> 
> ulabls = unique(sams.All$label)
> NK = ulabls[grep("NK", ulabls)]
> NK
[1] "CD56+ NK cells"                          
[2] "CD3-CD56+CD57- canonical NK cells"       
[3] "CD3-CD56+CD57+EAT-2- adaptive NK cells"  
[4] "CD3-CD56+CD57dim canonical NK cells"     
[5] "CD3-CD56+CD57+EAT-2int adaptive NK cells"
[6] "CD3-CD56+CD57+EAT-2+ canonical NK cells" 
> sams.All$label[which(sams.All$label %in% NK)] = "NK"
> 
> B = c("CD19+ B cells")
> sams.All$label[which(sams.All$label %in% B)] = "B"
> 
> CD4T = ulabls[grep("CD4", ulabls)]
> CD4T
[1] "CD4+ T cells" "CD4 T cells"  "CD4+ cell"   
> sams.All$label[which(sams.All$label %in% CD4T)] = "CD4T"
> 
> CD8T = ulabls[grep("CD8", ulabls)]
> CD8T
[1] "CD8+ T cells" "CD8 T cells" 
> sams.All$label[which(sams.All$label %in% CD8T)] = "CD8T"
> 
> Neutrophil = c("Neutrophils", "normal neutrophils")
> sams.All$label[which(sams.All$label %in% Neutrophil)] = "Neutrophil"
> 
> table(sams.All$label)

           B         CD4T         CD8T           DC  Eosinophils Granulocytes 
           6           60           37            3            6            6 
  Macrophage     Monocyte   Neutrophil           NK         PBMC         Treg 
           3           43           21           21            6            4 
 Whole blood 
           6 
> table(sams.All$label, sams.All$study)
              
               Coit Limbach Reinius Reynolds Schlums Vento Zhang
  B               0       0       6        0       0     0     0
  CD4T            0      31       6       23       0     0     0
  CD8T            0      31       6        0       0     0     0
  DC              0       0       0        0       0     3     0
  Eosinophils     0       0       6        0       0     0     0
  Granulocytes    0       0       6        0       0     0     0
  Macrophage      0       0       0        0       0     3     0
  Monocyte        0       0       6       34       0     3     0
  Neutrophil     15       0       6        0       0     0     0
  NK              0       0       6        0      15     0     0
  PBMC            0       0       6        0       0     0     0
  Treg            0       0       0        0       0     0     4
  Whole blood     0       0       6        0       0     0     0
> 
> dim(sams.All)
[1] 222   3
> sams.All[1:5,]
          id       label   study
1: GSM861635 Whole blood Reinius
2: GSM861636 Whole blood Reinius
3: GSM861637 Whole blood Reinius
4: GSM861638 Whole blood Reinius
5: GSM861639 Whole blood Reinius
> 
> # ------------------------------------------------------------
> # combine data
> # ------------------------------------------------------------
> 
> unique(sams.All$study)
[1] "Reinius"  "Limbach"  "Reynolds" "Vento"    "Coit"     "Zhang"    "Schlums" 
> 
> dim(dat.Reinius)
[1] 392794     61
> dim(dat.Limbach)
[1] 325517     63
> dim(dat.Reynolds.CD4)
[1] 393401     24
> dim(dat.Reynolds.mono)
[1] 393401     35
> dim(dat.Vento)
[1] 393054     10
> dim(dat.Coit)
[1] 393341     16
> dim(dat.Zhang)
[1] 393006      5
> dim(dat.Schlums)
[1] 355805     16
> 
> cpgs = intersect(dat.Reinius$id, dat.Limbach$id)
> length(cpgs)
[1] 325036
> 
> cpgs = intersect(cpgs, dat.Reynolds.CD4$id)
> length(cpgs)
[1] 325036
> 
> cpgs = intersect(cpgs, dat.Reynolds.mono$id)
> length(cpgs)
[1] 325036
> 
> cpgs = intersect(cpgs, dat.Vento$id)
> length(cpgs)
[1] 325022
> 
> cpgs = intersect(cpgs, dat.Coit$id)
> length(cpgs)
[1] 324979
> 
> cpgs = intersect(cpgs, dat.Zhang$id)
> length(cpgs)
[1] 324846
> 
> 
> table(Foxp3 %in% cpgs)

TRUE 
   8 
> mat1 = match(cpgs, info$ID)
> table(info$CHR[mat1])

    1    10    11    12    13    14    15    16    17    18    19     2    20 
31713 15986 19636 16708  8017 10099 10128 14221 19066  4127 17598 23331  7154 
   21    22     3     4     5     6     7     8     9     X     Y 
 2768  5654 17332 13399 16247 23455 19063 13604  6715  8808    17 
> 
> # since the study of Schlums does not include sex chromsome
> # we will not take intersection here. 
> # cpgs = intersect(cpgs, dat.Schlums$id)
> # length(cpgs)
> 
> info1 = info[which(info$ID %in% cpgs),]
> dim(info1)
[1] 324846     31
> info1[1:2,]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg00000029 cg00000029                   II                        
2: cg00000165 cg00000165                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37  16 53468112            16      52025613      F         NA
2:           37   1 91194674             1      90967262      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci UCSC_RefGene_Name
1:            NA          NA            NA              RBL2
2:            NA          NA            NA                  
   UCSC_RefGene_Accession UCSC_RefGene_Group   UCSC_CpG_Islands_Name
1:              NM_005611            TSS1500 chr16:53468284-53469209
2:                                            chr1:91190489-91192804
   Relation_to_UCSC_CpG_Island Phantom  DMR Enhancer          HMM_Island
1:                     N_Shore                    NA                    
2:                     S_Shore         CDMR     TRUE 1:90967262-90967361
   Regulatory_Feature_Name Regulatory_Feature_Group  DHS RANGE_START RANGE_END
1:    16:53467838-53469685      Promoter_Associated TRUE    53468112  53468235
2:                                                    NA    91194674  91194797
       RANGE_GB SPOT_ID
1:  NC_000016.9      NA
2: NC_000001.10      NA
> 
> table(Foxp3 %in% info1$ID)

TRUE 
   8 
> 
> data.All = dat.Reinius[match(info1$ID, dat.Reinius$id),]
> data.All = cbind(data.All, dat.Limbach[match(info1$ID, dat.Limbach$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Reynolds.CD4[match(info1$ID, dat.Reynolds.CD4$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Reynolds.mono[match(info1$ID, dat.Reynolds.mono$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Vento[match(info1$ID, dat.Vento$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Coit[match(info1$ID, dat.Coit$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Zhang[match(info1$ID, dat.Zhang$id), -1, with=FALSE])
> data.All = cbind(data.All, dat.Schlums[match(info1$ID, dat.Schlums$id), -1, with=FALSE])
> 
> dim(data.All)
[1] 324846    223
> data.All[1:2,]
           id GSM861635 GSM861636 GSM861637 GSM861638 GSM861639 GSM861640
1: cg00000029 0.5413522 0.4889614 0.5140406 0.5423428  0.462014 0.5314223
2: cg00000165 0.2204557 0.1613999 0.1826917 0.1668749  0.150886 0.1380858
   GSM861641 GSM861642 GSM861643 GSM861644 GSM861645 GSM861646 GSM861647
1: 0.5558568  0.564972 0.6256095 0.6454731 0.6067712 0.6323403 0.4500496
2: 0.2231428  0.182366 0.2261681 0.1945970 0.1775802 0.2017216 0.1208339
   GSM861648 GSM861649 GSM861650 GSM861651 GSM861652 GSM861653 GSM861654
1: 0.3823125 0.4417149 0.4167075 0.4092516 0.4446326 0.6535943 0.6739647
2: 0.2166066 0.2160755 0.1482985 0.1607821 0.1598454 0.2418252 0.2204196
   GSM861655 GSM861656 GSM861657 GSM861658 GSM861659 GSM861660 GSM861661
1: 0.6859416 0.6771851 0.7098604 0.7422827 0.7011350 0.7205192 0.7980741
2: 0.2108645 0.1655189 0.2066188 0.2039282 0.3135682 0.2181360 0.2376423
   GSM861662 GSM861663 GSM861664 GSM861665 GSM861666 GSM861667 GSM861668
1: 0.7293479 0.7958531 0.7564468 0.4719443 0.4302344 0.4680349 0.4248562
2: 0.2014507 0.2039902 0.2283086 0.1595005 0.1562449 0.1658281 0.1614590
   GSM861669 GSM861670 GSM861671 GSM861672 GSM861673 GSM861674 GSM861675
1: 0.4556493 0.4673256 0.6154734 0.6383815 0.6393484 0.6502703 0.6354113
2: 0.1454558 0.1581545 0.2214933 0.2052318 0.2062062 0.2109472 0.2113523
   GSM861676 GSM861677 GSM861678 GSM861679 GSM861680 GSM861681 GSM861682
1: 0.6717222 0.6683047 0.6674380 0.6953321 0.6735942 0.6451865 0.6604266
2: 0.1332635 0.3119538 0.1847721 0.1919780 0.1932543 0.1865906 0.1584789
   GSM861683 GSM861684 GSM861685 GSM861686 GSM861687 GSM861688 GSM861689
1: 0.4399422 0.3784253 0.4090205 0.3892886 0.4353659 0.4865833 0.2766066
2: 0.1715535 0.1419376 0.2420053 0.1655662 0.1533252 0.1495671 0.1696685
   GSM861690 GSM861691 GSM861692 GSM861693 GSM861694 GSM1848097 GSM1848096
1: 0.2260529 0.3186913 0.2723076 0.2498874 0.2954338  0.6500930  0.6878452
2: 0.1658333 0.2092078 0.1544931 0.1710391 0.1477374  0.2606096  0.2564694
   GSM1848095 GSM1848094 GSM1848093 GSM1848092 GSM1848091 GSM1848090 GSM1848089
1:  0.6075558  0.6736537  0.7391058  0.6800622  0.7445876  0.6486612  0.6934299
2:  0.2985161  0.3168454  0.2442290  0.2688904  0.3039963  0.3068255  0.3224864
   GSM1848088 GSM1848087 GSM1848086 GSM1848085 GSM1848084 GSM1848083 GSM1848082
1:  0.6649343  0.6402788  0.6199663  0.6828232  0.7125475  0.6458975  0.7053223
2:  0.3056034  0.2463935  0.2776590  0.2479253  0.3237547  0.3699133  0.3025581
   GSM1848081 GSM1848080 GSM1848079 GSM1848078 GSM1848077 GSM1848076 GSM1848075
1:  0.6844111  0.7452053  0.7022131  0.6269328  0.7163633  0.7273144  0.7022973
2:  0.3402497  0.2806744  0.4011611  0.3167772  0.2887346  0.3536687  0.3388622
   GSM1848074 GSM1848073 GSM1848072 GSM1848071 GSM1848070 GSM1848068 GSM1848065
1:  0.6559004  0.6773810  0.7116196  0.7400317  0.7397200  0.7188707  0.7305771
2:  0.2454971  0.3227511  0.2895959  0.2422538  0.2720503  0.2830329  0.2673007
   GSM1848063 GSM1848022 GSM1848021 GSM1848020 GSM1848019 GSM1848018 GSM1848017
1:  0.6230955  0.6809540  0.6788329  0.6483688  0.6683518  0.7293629  0.7080581
2:  0.2850181  0.3062317  0.2389723  0.2771325  0.3166027  0.2818074  0.2827469
   GSM1848016 GSM1848015 GSM1848014 GSM1848013 GSM1848012 GSM1848011 GSM1848010
1:  0.6599005  0.6288470  0.6562251  0.6263193  0.7119507  0.7363000  0.6855386
2:  0.3028519  0.2632606  0.3161123  0.2763519  0.2537278  0.3192845  0.2674405
   GSM1848009 GSM1848008 GSM1848007 GSM1848006 GSM1848005 GSM1848004 GSM1848003
1:  0.7008576  0.6579877  0.7121303  0.7156024  0.7015803  0.7159038  0.6532378
2:  0.2669642  0.3532569  0.2677232  0.2647727  0.2586203  0.3436609  0.2659736
   GSM1848002 GSM1848001 GSM1848000 GSM1847999 GSM1847998 GSM1847997 GSM1847996
1:  0.6830791  0.7232441  0.6705295  0.6140348  0.6561995  0.7258857  0.6340425
2:  0.3040169  0.2655507  0.3397843  0.2448319  0.2899948  0.2554553  0.2699676
   GSM1847995 GSM1847994 GSM1847993 GSM1847992 GSM1364563 GSM1364558 GSM1364556
1:  0.6572791  0.7597718  0.6855117  0.6891052  0.7078486  0.7636942  0.7551539
2:  0.2673450  0.2609209  0.2756206  0.3040812  0.1880868  0.2305282  0.2120848
   GSM1364555 GSM1364551 GSM1364545 GSM1364544 GSM1364541 GSM1364537 GSM1364534
1:  0.7578660  0.7831209  0.7401979  0.8004197  0.7296543  0.7248451  0.8013189
2:  0.2150931  0.1962079  0.2226268  0.2246261  0.2113898  0.1908436  0.2079911
   GSM1364533 GSM1364531 GSM1364528 GSM1364527 GSM1364522 GSM1364521 GSM1364504
1:  0.8269437  0.7496119  0.7318727  0.8592296  0.7742574  0.7646903  0.7524434
2:  0.2164687  0.2203134  0.1752605  0.3241419  0.3451257  0.2157985  0.2301011
   GSM1364496 GSM1364481 GSM1364480 GSM1364476 GSM1364462 GSM1364457 GSM1354359
1:  0.7631441  0.7485963  0.7452440  0.7803039  0.7837185  0.7963847  0.5384750
2:  0.1809312  0.1639343  0.2343852  0.2362948  0.2365507  0.2201699  0.1411821
   GSM1354339 GSM1354305 GSM1354290 GSM1354255 GSM1354248 GSM1354219 GSM1354216
1:  0.5047904  0.6031987  0.4396946  0.4853972  0.5329355  0.5113936  0.5324861
2:  0.1320180  0.1803171  0.1099649  0.1598259  0.1592210  0.1417481  0.1887031
   GSM1354204 GSM1354195 GSM1354191 GSM1354158 GSM1354139 GSM1354095 GSM1354085
1:  0.5693094  0.5729395 0.84582319  0.5031635  0.5261885  0.4751990  0.5423038
2:  0.1799363  0.1670759 0.08672956  0.1245764  0.1280273  0.1795144  0.1224930
   GSM1354055 GSM1354010 GSM1353959 GSM1353945 GSM1353915 GSM1353913 GSM1353790
1:  0.4496762  0.3705355  0.3896365  0.3738263  0.5879381  0.4555022  0.5111091
2:  0.1352079  0.3372060  0.1514536  0.1259233  0.1379757  0.1836503  0.1081320
   GSM1353708 GSM1353617 GSM1353581 GSM1353530 GSM1353529 GSM1353454 GSM1353446
1:  0.3755647  0.4169419  0.3592944  0.4205824  0.5545994  0.4467924  0.5735197
2:  0.1330988  0.1117726  0.1421501  0.1277811  0.3977205  0.1507293  0.1333417
   GSM1353443 GSM1353387 GSM1353246 GSM1353243 GSM1353209 GSM1846592 GSM1846591
1:  0.4791626  0.6795018  0.4955946  0.5730937  0.4868503  0.7423225  0.6915279
2:  0.1391444  0.4545929  0.1557220  0.1198771  0.1491122  0.6678801  0.5308191
   GSM1846590 GSM1846586 GSM1846585 GSM1846584 GSM1846580 GSM1846579 GSM1846578
1:  0.7677006  0.7079468  0.7657933  0.8208724  0.7994820  0.7888979  0.7927951
2:  0.6252498  0.5737686  0.5772528  0.6417041  0.6657538  0.5769231  0.6212584
   GSM1587293 GSM1587292 GSM1587289 GSM1587288 GSM1587284 GSM1587283 GSM1587280
1:  0.4619165  0.4832633  0.3962995  0.3925624  0.4667704   0.346006  0.4067558
2:  0.1576691  0.1497034  0.1347503  0.1365024  0.1835381   0.122772  0.1488805
   GSM1587279 GSM1587278 GSM1587273 GSM1587272 GSM1587267 GSM1587266 GSM1587261
1:  0.3388337  0.3547061  0.4680358  0.4495811  0.4355793  0.4175602  0.4477818
2:  0.1801737  0.2277267  0.1922189  0.1735055  0.1878144  0.1673565  0.2302686
   GSM1587260 GSM1204714 GSM1204712 GSM1204710 GSM1204706 GSM1625014 GSM1625013
1:  0.5365330  0.7383157  0.8045520  0.8089875  0.8235851  0.6532010  0.8814443
2:  0.1816599  0.2168212  0.1522879  0.2314524  0.1442613  0.1370417  0.4798787
   GSM1625012 GSM1625010 GSM1625009 GSM1625007 GSM1625006 GSM1625004 GSM1625003
1:  0.6962613  0.7888444  0.8027084  0.7063390  0.9341908  0.8140960  0.9108635
2:  0.1126518  0.1240616  0.1011248  0.1797457  0.1321789  0.2386717  0.2717381
   GSM1625002 GSM1625000 GSM1624998 GSM1624996 GSM1624995 GSM1624993
1:  0.7754229  0.7976404  0.6554371  0.7608090  0.7814706  0.6784179
2:  0.2814848  0.2307445  0.3014993  0.2540308  0.2612079  0.2427715
> 
> table(names(data.All)[-1] == sams.All$id)

TRUE 
 222 
> 
> # -----------------------------------------------------------------
> # select probes that are cell-type-specific
> # -----------------------------------------------------------------
> 
> dim(sams.All)
[1] 222   3
> sams.All[1:5,]
          id       label   study
1: GSM861635 Whole blood Reinius
2: GSM861636 Whole blood Reinius
3: GSM861637 Whole blood Reinius
4: GSM861638 Whole blood Reinius
5: GSM861639 Whole blood Reinius
> 
> table(sams.All$label)

           B         CD4T         CD8T           DC  Eosinophils Granulocytes 
           6           60           37            3            6            6 
  Macrophage     Monocyte   Neutrophil           NK         PBMC         Treg 
           3           43           21           21            6            4 
 Whole blood 
           6 
> 
> ctypes = setdiff(unique(sams.All$label), c("PBMC", "Whole blood"))
> wctype = which(sams.All$label %in% ctypes)
> 
> table(data.All$id == info1$ID)

  TRUE 
324846 
> 
> sams.ctype = sams.All[wctype,]
> data.ctype = data.All[,which(names(data.All) %in% sams.ctype$id), with=FALSE]
> 
> dim(data.ctype)
[1] 324846    210
> data.ctype[1:2,1:5]
   GSM861647 GSM861648 GSM861649 GSM861650 GSM861651
1: 0.4500496 0.3823125 0.4417149 0.4167075 0.4092516
2: 0.1208339 0.2166066 0.2160755 0.1482985 0.1607821
> 
> data.ctype = data.matrix(data.ctype)
> data.ctype[1:2,1:5]
     GSM861647 GSM861648 GSM861649 GSM861650 GSM861651
[1,] 0.4500496 0.3823125 0.4417149 0.4167075 0.4092516
[2,] 0.1208339 0.2166066 0.2160755 0.1482985 0.1607821
> 
> dim(sams.ctype)
[1] 210   3
> sams.ctype[1:2,]
          id        label   study
1: GSM861647 Granulocytes Reinius
2: GSM861648 Granulocytes Reinius
> 
> nna = colSums(is.na(data.ctype))
> table(sams.ctype$study[nna > 0])

Schlums 
     15 
> 
> table(sams.ctype$study)

    Coit  Limbach  Reinius Reynolds  Schlums    Vento    Zhang 
      15       62       48       57       15        9        4 
> table(sams.ctype$label)

           B         CD4T         CD8T           DC  Eosinophils Granulocytes 
           6           60           37            3            6            6 
  Macrophage     Monocyte   Neutrophil           NK         Treg 
           3           43           21           21            4 
> 
> utypes = unique(sams.ctype$label)
> length(utypes)
[1] 11
> 
> v   = as.numeric(data.ctype[1,])
> lbs = sams.ctype$label
> 
> ttest <- function(v, lbs, lb1){
+   t1 = t.test(x=v[which(lbs == lb1)], y=v[which(lbs != lb1)])
+   t1$p.value
+ }
> 
> pvs = matrix(nrow=nrow(data.ctype), ncol=length(utypes))
> 
> for(j in 1:length(utypes)){
+   cat(j, date(), "\n")
+   lb1 = utypes[j]
+   pvs[,j] = apply(data.ctype, 1, ttest, lbs=sams.ctype$label, lb1=lb1)
+ }
1 Wed Feb 15 21:53:06 2017 
2 Wed Feb 15 21:54:33 2017 
3 Wed Feb 15 21:56:00 2017 
4 Wed Feb 15 21:57:28 2017 
5 Wed Feb 15 21:58:53 2017 
6 Wed Feb 15 22:00:21 2017 
7 Wed Feb 15 22:01:51 2017 
8 Wed Feb 15 22:03:19 2017 
9 Wed Feb 15 22:04:46 2017 
10 Wed Feb 15 22:06:10 2017 
11 Wed Feb 15 22:07:31 2017 
> 
> summary(pvs)
       V1                  V2                  V3                 V4         
 Min.   :0.0000000   Min.   :0.0000000   Min.   :0.000000   Min.   :0.00000  
 1st Qu.:0.0000017   1st Qu.:0.0006573   1st Qu.:0.000000   1st Qu.:0.00000  
 Median :0.0020851   Median :0.0291668   Median :0.000000   Median :0.00000  
 Mean   :0.1226746   Mean   :0.1886640   Mean   :0.080370   Mean   :0.09682  
 3rd Qu.:0.1051726   3rd Qu.:0.2956546   3rd Qu.:0.001236   3rd Qu.:0.00647  
 Max.   :0.9999765   Max.   :0.9999876   Max.   :0.999990   Max.   :0.99993  
       V5                  V6                  V7           
 Min.   :0.0000000   Min.   :0.0000000   Min.   :0.0000000  
 1st Qu.:0.0009495   1st Qu.:0.0000245   1st Qu.:0.0000000  
 Median :0.0353184   Median :0.0117318   Median :0.0000002  
 Mean   :0.1804463   Mean   :0.1605753   Mean   :0.0794665  
 3rd Qu.:0.2656838   3rd Qu.:0.2140135   3rd Qu.:0.0071158  
 Max.   :0.9999945   Max.   :0.9999951   Max.   :0.9999636  
       V8                  V9                V10                 V11         
 Min.   :0.0000000   Min.   :0.000000   Min.   :0.0000000   Min.   :0.00000  
 1st Qu.:0.0000009   1st Qu.:0.000000   1st Qu.:0.0000015   1st Qu.:0.02545  
 Median :0.0018636   Median :0.004622   Median :0.0014736   Median :0.18679  
 Mean   :0.1216872   Mean   :0.062328   Mean   :0.0572233   Mean   :0.29783  
 3rd Qu.:0.1030453   3rd Qu.:0.032326   3rd Qu.:0.0151442   3rd Qu.:0.52170  
 Max.   :0.9999897   Max.   :0.999873   Max.   :0.9999144   Max.   :0.99999  
> colSums(pvs < 0.01)
 [1] 191289 134278 256163 246291 125888 159071 246797 192472 182823 230372
[11]  61403
> colSums(pvs < 1e-3)
 [1] 150430  87059 242321 234318  81913 120236 227658 152567 141280 152845
[11]  35279
> colSums(pvs < 1e-4)
 [1] 118676  64052 228479 225526  57945  93759 210468 121942 122395 115236
[11]  23860
> colSums(pvs < 1e-5)
 [1]  95176  54184 214023 218000  43694  74051 193071  98848 109156  93442
[11]  17900
> colSums(pvs < 1e-6)
 [1]  77627  47906 198557 210962  34294  57772 174938  81750  98752  78828
[11]  14273
> pcut = 0.05/nrow(info1)
> pcut
[1] 1.539191e-07
> colSums(pvs < pcut)
 [1]  66671  43856 183711 205201  28856  46798 160091  71260  91990  69929
[11]  12225
> 
> pvs[match(Foxp3, info1$ID),]
             [,1]         [,2]         [,3]         [,4]         [,5]
[1,] 3.344874e-18 5.995411e-04 1.547808e-08 3.525914e-14 1.802195e-03
[2,] 3.034245e-01 7.892501e-01 4.993948e-01 5.000906e-10 3.240357e-01
[3,] 3.361989e-02 4.738817e-01 1.025730e-01 5.629592e-25 3.020098e-09
[4,] 9.036442e-03 4.711387e-15 5.878443e-05 1.788484e-10 3.901889e-05
[5,] 1.114274e-02 2.895521e-01 4.053654e-05 1.741220e-18 3.301060e-01
[6,] 4.941813e-01 1.655590e-01 1.623860e-04 4.127057e-39 2.494960e-08
[7,] 2.082247e-06 2.169185e-01 4.256956e-07 9.324993e-12 2.339211e-02
[8,] 4.795513e-01 4.397107e-01 3.023399e-05 1.021438e-19 2.946413e-02
             [,6]         [,7]         [,8]         [,9]        [,10]
[1,] 7.724412e-01 1.451332e-01 5.530622e-09 7.116307e-03 3.056802e-03
[2,] 6.744933e-01 5.764173e-03 2.793130e-02 1.036909e-14 6.811059e-11
[3,] 9.662690e-01 1.561491e-01 2.608844e-04 3.792469e-30 3.364468e-31
[4,] 2.725775e-08 8.362797e-10 5.362866e-04 2.426512e-04 5.523342e-06
[5,] 7.602312e-05 2.314912e-07 6.901183e-02 4.716376e-04 2.350673e-10
[6,] 2.769571e-04 6.934223e-01 2.475349e-04 4.320525e-37 4.397191e-14
[7,] 1.716285e-01 6.417812e-03 2.010347e-03 2.720948e-03 6.498030e-04
[8,] 7.989838e-01 8.133161e-05 2.222713e-01 1.274840e-33 7.558506e-10
            [,11]
[1,] 1.409569e-02
[2,] 6.162625e-04
[3,] 3.675776e-03
[4,] 3.729531e-48
[5,] 9.420999e-05
[6,] 7.474208e-03
[7,] 8.772599e-04
[8,] 3.883370e-02
> info1[match(Foxp3, info1$ID),]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg01905377 cg01905377                   II                        
2: cg02033323 cg02033323                   II                        
3: cg04920616 cg04920616                   II                        
4: cg06767008 cg06767008                   II                        
5: cg08884343 cg08884343                   II                        
6: cg10858077 cg10858077                   II                        
7: cg15614573 cg15614573                   II                        
8: cg16350494 cg16350494                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37   X 49122718             X      49009662      R         NA
2:           37   X 49118313             X      49005257      R         NA
3:           37   X 49121288             X      49008232      R         NA
4:           37   X 49114545             X      49001489      R         NA
5:           37   X 49122423             X      49009367      R         NA
6:           37   X 49121205             X      49008149      R         NA
7:           37   X 49122364             X      49009308      F         NA
8:           37   X 49121910             X      49008854      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci       UCSC_RefGene_Name
1:            NA          NA            NA             FOXP3;FOXP3
2:            NA          NA            NA             FOXP3;FOXP3
3:            NA          NA          TRUE             FOXP3;FOXP3
4:            NA          NA            NA             FOXP3;FOXP3
5:            NA          NA          TRUE             FOXP3;FOXP3
6:            NA          NA            NA FOXP3;FOXP3;FOXP3;FOXP3
7:            NA          NA            NA             FOXP3;FOXP3
8:            NA          NA            NA             FOXP3;FOXP3
                          UCSC_RefGene_Accession          UCSC_RefGene_Group
1:                        NM_014009;NM_001114377             TSS1500;TSS1500
2:                        NM_014009;NM_001114377                 5'UTR;5'UTR
3:                        NM_014009;NM_001114377               TSS200;TSS200
4:                        NM_014009;NM_001114377                   Body;Body
5:                        NM_014009;NM_001114377             TSS1500;TSS1500
6: NM_001114377;NM_014009;NM_014009;NM_001114377 1stExon;5'UTR;1stExon;5'UTR
7:                        NM_014009;NM_001114377             TSS1500;TSS1500
8:                        NM_014009;NM_001114377             TSS1500;TSS1500
    UCSC_CpG_Islands_Name Relation_to_UCSC_CpG_Island Phantom DMR Enhancer
1: chrX:49125645-49127200                     N_Shelf                   NA
2:                                                                      NA
3:                                                                      NA
4:                                                                      NA
5: chrX:49125645-49127200                     N_Shelf                   NA
6:                                                                      NA
7: chrX:49125645-49127200                     N_Shelf                   NA
8: chrX:49125645-49127200                     N_Shelf                   NA
   HMM_Island Regulatory_Feature_Name        Regulatory_Feature_Group DHS
1:                                                                     NA
2:                                                                     NA
3:                                                                     NA
4:                X:49114410-49114805 Unclassified_Cell_type_specific  NA
5:                                                                     NA
6:                                                                     NA
7:                                                                     NA
8:                                                                     NA
   RANGE_START RANGE_END     RANGE_GB SPOT_ID
1:    49122718  49122841 NC_000023.10      NA
2:    49118313  49118436 NC_000023.10      NA
3:    49121288  49121411 NC_000023.10      NA
4:    49114545  49114668 NC_000023.10      NA
5:    49122423  49122546 NC_000023.10      NA
6:    49121205  49121328 NC_000023.10      NA
7:    49122364  49122487 NC_000023.10      NA
8:    49121910  49122033 NC_000023.10      NA
> 
> pv.min = apply(pvs, 1, min)
> summary(pv.min)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.00e+00 0.00e+00 0.00e+00 7.87e-05 0.00e+00 4.56e-01 
> 
> table(pv.min < pcut)

 FALSE   TRUE 
 41924 282922 
> 
> dat = data.ctype[which(pv.min < pcut),]
> dim(dat)
[1] 282922    210
> 
> # ------------------------------------------------------------
> # joint PCA
> # ------------------------------------------------------------
> 
> dat4Pr = dat - rowMeans(dat, na.rm=TRUE)
> 
> dat4Pr[is.na(dat4Pr)] = 0
> covdat = t(dat4Pr) %*% dat4Pr / nrow(dat4Pr)
> dim(covdat)
[1] 210 210
> prdat  = eigen(covdat)
> 
> prdat$values[1:20]
 [1] 0.788193184 0.286932288 0.196673399 0.101378019 0.080909119 0.052744014
 [7] 0.044946440 0.025774165 0.015914415 0.011188872 0.009866348 0.008885559
[13] 0.007880143 0.007374928 0.006436570 0.005324176 0.005274322 0.004433767
[19] 0.004206097 0.003773396
> 
> PC1 =  prdat$vectors[,1]
> PC2 =  prdat$vectors[,2]
> PC3 =  prdat$vectors[,3]
> 
> sams.ctype$study1 = sams.ctype$study
> sams.ctype$study1[which(sams.ctype$study %in% c("Vento", "Zhang"))] = "VZ"
> table(sams.ctype$study1)

    Coit  Limbach  Reinius Reynolds  Schlums       VZ 
      15       62       48       57       15       13 
> 
> ev = data.frame(index=1:20, eigenValue=prdat$values[1:20])
> p1 <- ggplot(ev, aes(index, eigenValue)) + geom_bar(stat = "identity")
> p1
> 
> ggsave("../figures/methylation_PCA_eigen_values.pdf", width=9, height=6, 
+        units="in")
> 
> p2 <- ggplot(sams.ctype, aes(PC1, PC2, shape = factor(study1)))
> p2 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_PC1_vs_PC2.pdf", width=9, height=6, 
+        units="in")
> 
> p3 <- ggplot(sams.ctype, aes(PC1, PC3, shape = factor(study1)))
> p3 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_PC1_vs_PC3.pdf", width=9, height=6, 
+        units="in")
> 
> p4 <- ggplot(sams.ctype, aes(PC2, PC3, shape = factor(study1)))
> p4 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_PC2_vs_PC3.pdf", width=9, height=6, 
+        units="in")
> 
> table(sams.ctype$study1, sams.ctype$label)
          
            B CD4T CD8T DC Eosinophils Granulocytes Macrophage Monocyte
  Coit      0    0    0  0           0            0          0        0
  Limbach   0   31   31  0           0            0          0        0
  Reinius   6    6    6  0           6            6          0        6
  Reynolds  0   23    0  0           0            0          0       34
  Schlums   0    0    0  0           0            0          0        0
  VZ        0    0    0  3           0            0          3        3
          
           Neutrophil NK Treg
  Coit             15  0    0
  Limbach           0  0    0
  Reinius           6  6    0
  Reynolds          0  0    0
  Schlums           0 15    0
  VZ                0  0    4
> 
> # ------------------------------------------------------------
> # remove the study of Vento since it looks too different, 
> # and remove batch effect at m-value scale
> # ------------------------------------------------------------
> 
> dim(data.ctype)
[1] 324846    210
> dim(sams.ctype)
[1] 210   4
> w2rm = which(sams.ctype$study == "Vento")
> length(w2rm)
[1] 9
> 
> sams.ctype = sams.ctype[-w2rm,]
> data.ctype = data.ctype[,-w2rm]
> 
> table(sams.ctype$study, sams.ctype$label)
          
            B CD4T CD8T Eosinophils Granulocytes Monocyte Neutrophil NK Treg
  Coit      0    0    0           0            0        0         15  0    0
  Limbach   0   31   31           0            0        0          0  0    0
  Reinius   6    6    6           6            6        6          6  6    0
  Reynolds  0   23    0           0            0       34          0  0    0
  Schlums   0    0    0           0            0        0          0 15    0
  Zhang     0    0    0           0            0        0          0  0    4
> table(colnames(data.ctype) == sams.ctype$id)

TRUE 
 201 
> 
> # ------------------------------------------------------------
> # remove cell types Eosinophils and Granulocytes
> # ------------------------------------------------------------
> 
> dim(data.ctype)
[1] 324846    201
> dim(sams.ctype)
[1] 201   4
> w2rm = which(sams.ctype$label %in% c("Eosinophils", "Granulocytes"))
> length(w2rm)
[1] 12
> 
> sams.ctype = sams.ctype[-w2rm,]
> data.ctype = data.ctype[,-w2rm]
> 
> table(sams.ctype$study, sams.ctype$label)
          
            B CD4T CD8T Monocyte Neutrophil NK Treg
  Coit      0    0    0        0         15  0    0
  Limbach   0   31   31        0          0  0    0
  Reinius   6    6    6        6          6  6    0
  Reynolds  0   23    0       34          0  0    0
  Schlums   0    0    0        0          0 15    0
  Zhang     0    0    0        0          0  0    4
> table(colnames(data.ctype) == sams.ctype$id)

TRUE 
 189 
> 
> # ------------------------------------------------------------
> # remove batch effect at m-value scale
> # ------------------------------------------------------------
> 
> min(c(data.ctype), na.rm=TRUE)
[1] 0
> data.ctype[data.ctype < 1e-4] = 1e-4
> min(c(data.ctype), na.rm=TRUE)
[1] 1e-04
> c1 = colSums(data.ctype <= 1e-4, na.rm=TRUE)
> c1
 GSM861653  GSM861654  GSM861655  GSM861656  GSM861657  GSM861658  GSM861659 
      2597       1913       2393       1611       2026       2382       1719 
 GSM861660  GSM861661  GSM861662  GSM861663  GSM861664  GSM861665  GSM861666 
      1918       1633       1151        705        831       1333       2218 
 GSM861667  GSM861668  GSM861669  GSM861670  GSM861671  GSM861672  GSM861673 
      2325       1212       1072       1279       2065       2226       2339 
 GSM861674  GSM861675  GSM861676  GSM861677  GSM861678  GSM861679  GSM861680 
       874       1795       3232       2169       2465       2159       1186 
 GSM861681  GSM861682  GSM861683  GSM861684  GSM861685  GSM861686  GSM861687 
      1296       2680       1606       1456       1344       2959       3332 
 GSM861688 GSM1848097 GSM1848096 GSM1848095 GSM1848094 GSM1848093 GSM1848092 
      5082          0          0          0          0          0          0 
GSM1848091 GSM1848090 GSM1848089 GSM1848088 GSM1848087 GSM1848086 GSM1848085 
         0          0          0          0          0          0          0 
GSM1848084 GSM1848083 GSM1848082 GSM1848081 GSM1848080 GSM1848079 GSM1848078 
         0          0          0          0          0          0          0 
GSM1848077 GSM1848076 GSM1848075 GSM1848074 GSM1848073 GSM1848072 GSM1848071 
         0          0          0          0          0          0          0 
GSM1848070 GSM1848068 GSM1848065 GSM1848063 GSM1848022 GSM1848021 GSM1848020 
         0          0          0          0          0          0          0 
GSM1848019 GSM1848018 GSM1848017 GSM1848016 GSM1848015 GSM1848014 GSM1848013 
         0          0          0          0          0          0          0 
GSM1848012 GSM1848011 GSM1848010 GSM1848009 GSM1848008 GSM1848007 GSM1848006 
         0          0          0          0          0          0          0 
GSM1848005 GSM1848004 GSM1848003 GSM1848002 GSM1848001 GSM1848000 GSM1847999 
         0          0          0          0          0          0          0 
GSM1847998 GSM1847997 GSM1847996 GSM1847995 GSM1847994 GSM1847993 GSM1847992 
         0          0          0          0          0          0          0 
GSM1364563 GSM1364558 GSM1364556 GSM1364555 GSM1364551 GSM1364545 GSM1364544 
         0          0          0          0          0          0          0 
GSM1364541 GSM1364537 GSM1364534 GSM1364533 GSM1364531 GSM1364528 GSM1364527 
         0          0          0          0          0          0          0 
GSM1364522 GSM1364521 GSM1364504 GSM1364496 GSM1364481 GSM1364480 GSM1364476 
         0          0          0          0          0          0          0 
GSM1364462 GSM1364457 GSM1354359 GSM1354339 GSM1354305 GSM1354290 GSM1354255 
         0          0          0          0          0          0          0 
GSM1354248 GSM1354219 GSM1354216 GSM1354204 GSM1354195 GSM1354191 GSM1354158 
         0          0          0          0          0          0          0 
GSM1354139 GSM1354095 GSM1354085 GSM1354055 GSM1354010 GSM1353959 GSM1353945 
         0          0          0          0          0          0          0 
GSM1353915 GSM1353913 GSM1353790 GSM1353708 GSM1353617 GSM1353581 GSM1353530 
         0          0          0          0          0          0          0 
GSM1353529 GSM1353454 GSM1353446 GSM1353443 GSM1353387 GSM1353246 GSM1353243 
         0          0          0          0          0          0          0 
GSM1353209 GSM1587293 GSM1587292 GSM1587289 GSM1587288 GSM1587284 GSM1587283 
         0       1932       2148       1414       1637       1896       4040 
GSM1587280 GSM1587279 GSM1587278 GSM1587273 GSM1587272 GSM1587267 GSM1587266 
      1311        553        613        437        516        571        588 
GSM1587261 GSM1587260 GSM1204714 GSM1204712 GSM1204710 GSM1204706 GSM1625014 
       792        365          0          0          0          0          0 
GSM1625013 GSM1625012 GSM1625010 GSM1625009 GSM1625007 GSM1625006 GSM1625004 
         0          0          0          0          1          0          2 
GSM1625003 GSM1625002 GSM1625000 GSM1624998 GSM1624996 GSM1624995 GSM1624993 
         4          2          1          3          1          1          3 
> c2 = rowSums(data.ctype <= 1e-4, na.rm=TRUE)
> table(c2 > 0)

 FALSE   TRUE 
305930  18916 
> table(c2 > 2)

 FALSE   TRUE 
314495  10351 
> table(c2 > 5)

 FALSE   TRUE 
319113   5733 
> table(c2 > 10)

 FALSE   TRUE 
322565   2281 
> 
> table(sams.ctype$study[c1 > 0])

   Coit Reinius Schlums 
     15      36       9 
> table(sams.ctype$study)

    Coit  Limbach  Reinius Reynolds  Schlums    Zhang 
      15       62       36       57       15        4 
> max(c(data.ctype), na.rm=TRUE)
[1] 0.9995968
> 
> nna = colSums(is.na(data.ctype))
> table(sams.ctype$study[nna > 0])

Schlums 
     15 
> 
> data.ctype.m = log(data.ctype / (1 - data.ctype))
> 
> data.ctype.m.Nm = matrix(NA, nrow=nrow(data.ctype.m), ncol=ncol(data.ctype.m))
> colnames(data.ctype.m.Nm) = colnames(data.ctype.m)
> 
> grps = setdiff(unique(sams.ctype$label), "Treg")
> grps
[1] "CD4T"       "CD8T"       "Monocyte"   "B"          "NK"        
[6] "Neutrophil"
> 
> dim(dat.Schlums)
[1] 355805     16
> dim(data.ctype)
[1] 324846    189
> 
> table(info1$CHR, is.na(data.ctype[,189]))
    
     FALSE  TRUE
  1  31407   306
  10 15799   187
  11 19475   161
  12 16496   212
  13  7898   119
  14  9963   136
  15 10024   104
  16 14187    34
  17 18982    84
  18  4085    42
  19 17567    31
  2  23024   307
  20  7132    22
  21  2750    18
  22  5647     7
  3  17039   293
  4  13159   240
  5  16021   226
  6  23218   237
  7  18795   268
  8  13394   210
  9   6689    26
  X      0  8808
  Y      0    17
> 
> table(info1$CHR %in% c("X", "Y"), is.na(data.ctype[,189]))
       
         FALSE   TRUE
  FALSE 312751   3270
  TRUE       0   8825
> 
> library(preprocessCore)
> 
> for(nm1 in grps){
+   cat(nm1, date(), "\n")
+   
+   ww1  = which(sams.ctype$label == nm1 & sams.ctype$study=="Reinius")
+ 
+   data.ctype.m.Nm[,ww1] = normalize.quantiles(data.ctype.m[,ww1])
+ 
+   vals = apply(data.ctype.m.Nm[,ww1], 2, sort)
+ 
+   if(cor(vals[,1], vals[,2]) < 0.99){stop("cor is too small\n")}
+   
+   vals = rowMeans(vals)
+ 
+   ww2  = which(sams.ctype$label == nm1)
+   if(nm1 == "CD4T"){
+     ww2 = c(ww2, which(sams.ctype$label == "Treg"))
+   }
+   ww2
+ 
+   for(j in 1:length(ww2)){
+     
+     if(sams.ctype$study[ww2[j]] == "Schlums"){
+       
+       xj    = data.ctype.m[,ww2[j]]
+       wnaj  = which(!is.na(xj))
+       vals1 = vals[wnaj]
+       oj    = order(xj[wnaj])
+       
+       data.ctype.m.Nm[wnaj[oj],ww2[j]]= vals1
+     }else{
+       oj = order(data.ctype.m[,ww2[j]])
+       data.ctype.m.Nm[oj,ww2[j]] = vals
+     }
+   }
+ }
CD4T Wed Feb 15 22:09:14 2017 
CD8T Wed Feb 15 22:09:21 2017 
Monocyte Wed Feb 15 22:09:25 2017 
B Wed Feb 15 22:09:29 2017 
NK Wed Feb 15 22:09:30 2017 
Neutrophil Wed Feb 15 22:09:33 2017 
> 
> nna = colSums(is.na(data.ctype))
> table(sams.ctype$study[nna > 0])

Schlums 
     15 
> 
> nna = colSums(is.na(data.ctype.m.Nm))
> table(sams.ctype$study[nna > 0])

Schlums 
     15 
> 
> dim(data.ctype.m.Nm)
[1] 324846    189
> data.ctype.m.Nm[1:2,]
      GSM861653  GSM861654  GSM861655  GSM861656  GSM861657  GSM861658
[1,]  0.7467924  0.7409789  0.7660897  0.8241158  0.7662262  0.9903332
[2,] -1.2783407 -1.2420636 -1.1983589 -1.6112881 -1.3361233 -1.4032039
      GSM861659 GSM861660 GSM861661 GSM861662 GSM861663 GSM861664   GSM861665
[1,]  1.1171446  1.033820  1.347266  0.920053  1.116575  1.122984 -0.09685807
[2,] -0.9152335 -1.253575 -1.120745 -1.316733 -1.262840 -1.237721 -1.69151331
      GSM861666  GSM861667  GSM861668 GSM861669  GSM861670 GSM861671  GSM861672
[1,] -0.2602362 -0.1300472 -0.2968058 -0.199196 -0.1438282  0.633083  0.5358988
[2,] -1.6526710 -1.6165211 -1.6376368 -1.756696 -1.6967458 -1.504060 -1.2849277
      GSM861673 GSM861674  GSM861675  GSM861676  GSM861677  GSM861678
[1,]  0.8014729  0.459817  0.5128884  0.5874264  0.9072569  0.8748811
[2,] -1.4589827 -1.269194 -1.3077553 -1.6377460 -0.9263466 -1.5378145
      GSM861679  GSM861680  GSM861681  GSM861682  GSM861683  GSM861684
[1,]  0.8755195  0.6045362  0.4149311  0.5706342 -0.2613668 -0.4543725
[2,] -1.4938934 -1.4105309 -1.3697488 -1.4439336 -1.5719131 -1.7378714
     GSM861685  GSM861686  GSM861687  GSM861688 GSM1848097 GSM1848096
[1,] -0.354945 -0.4046246 -0.2748026 -0.1027125  0.5994526  0.7240407
[2,] -1.097417 -1.5300344 -1.8102121 -1.8422801 -1.5828318 -1.5240109
     GSM1848095 GSM1848094 GSM1848093 GSM1848092 GSM1848091 GSM1848090
[1,]  0.3613543  0.7314281   1.039110  0.6912521  0.9946284  0.5632953
[2,] -1.3578019 -1.3071177  -1.681707 -1.5121334 -1.3283158 -1.2907207
     GSM1848089 GSM1848088 GSM1848087 GSM1848086 GSM1848085 GSM1848084
[1,]  0.8354639  0.7000328  0.4490957  0.3850338  0.6744111   0.866786
[2,] -1.2857367 -1.3821723 -1.6197428 -1.4289942 -1.5981750  -1.226252
     GSM1848083 GSM1848082 GSM1848081 GSM1848080 GSM1848079 GSM1848078
[1,]  0.4737661  0.8195712  0.6135829   1.060673  0.7970163  0.4595993
[2,] -1.0309405 -1.3486370 -1.1500664  -1.538889 -0.8642358 -1.2751547
     GSM1848077 GSM1848076 GSM1848075 GSM1848074 GSM1848073 GSM1848072
[1,]  0.8590528  0.9497945  0.8526328  0.5064002  0.6392413  0.8398702
[2,] -1.4590284 -1.1657620 -1.0860599 -1.5435282 -1.1810646 -1.3748541
     GSM1848071 GSM1848070 GSM1848068 GSM1848065 GSM1848063 GSM1848022
[1,]  0.9860065  0.9856717  0.8308154  0.9324743  0.4002681  0.8552557
[2,] -1.6512242 -1.5058068 -1.4353595 -1.5135889 -1.5044939 -1.4562898
     GSM1848021 GSM1848020 GSM1848019 GSM1848018 GSM1848017 GSM1848016
[1,]  0.7804929  0.6845138  0.8115983   1.087014  0.9223136  0.6451019
[2,] -1.7614585 -1.7299089 -1.4320291  -1.610560 -1.5686643 -1.4702601
     GSM1848015 GSM1848014 GSM1848013 GSM1848012 GSM1848011 GSM1848010
[1,]  0.5717132  0.7335045  0.5739671  0.9087593   1.063740  0.8486725
[2,] -1.7110746 -1.4281917 -1.6992486 -1.5923975  -1.362174 -1.6642341
     GSM1848009 GSM1848008 GSM1848007 GSM1848006 GSM1848005 GSM1848004
[1,]  0.8948773  0.6287544  0.8970704  0.8556616   0.860095  0.9653857
[2,] -1.6899828 -1.2307824 -1.6476676 -1.6673061  -1.795351 -1.2942328
     GSM1848003 GSM1848002 GSM1848001 GSM1848000 GSM1847999 GSM1847998
[1,]  0.6020926  0.7701508   1.006579  0.7778161  0.4043942  0.6571122
[2,] -1.6412149 -1.5260495  -1.771119 -1.1731825 -1.7631467 -1.5132110
     GSM1847997 GSM1847996 GSM1847995 GSM1847994 GSM1847993 GSM1847992
[1,]   1.041066  0.4730413  0.6627936   1.186497  0.7214953  0.8391952
[2,]  -1.737910 -1.7268210 -1.6665202  -1.739102 -1.6019721 -1.5390589
     GSM1364563 GSM1364558 GSM1364556 GSM1364555 GSM1364551 GSM1364545
[1,]   0.613844  0.6753012  0.7502016  0.7192214  0.8825144  0.8179074
[2,]  -1.381041 -1.2100242 -1.2425943 -1.4270917 -1.5019080 -1.3587049
     GSM1364544 GSM1364541 GSM1364537 GSM1364534 GSM1364533 GSM1364531
[1,]   1.179329  0.9676638   0.850763  0.9263526   1.131025  0.9347133
[2,]  -1.346760 -1.4694532  -1.482800 -1.3679575  -1.334767 -1.3818194
     GSM1364528 GSM1364527 GSM1364522 GSM1364521 GSM1364504 GSM1364496
[1,]  0.8493752   1.187693  0.7939272  0.9275665  0.8620838  0.8000488
[2,] -1.5602317  -1.104366 -0.8335318 -1.2026955 -1.3116322 -1.5487971
     GSM1364481 GSM1364480 GSM1364476 GSM1364462 GSM1364457  GSM1354359
[1,]  0.9281099  0.8547788   1.025729  0.9276359   0.910208 -0.06646799
[2,] -1.4961740 -1.2681313  -1.142415 -1.0709057  -1.353311 -1.71344751
     GSM1354339 GSM1354305 GSM1354290 GSM1354255  GSM1354248 GSM1354219
[1,]  -0.251594  0.1346878 -0.3074817 -0.1647705 -0.03870449 -0.1951814
[2,]  -1.672719 -1.4385466 -1.7189924 -1.4156411 -1.40820694 -1.6894329
     GSM1354216  GSM1354204  GSM1354195 GSM1354191 GSM1354158 GSM1354139
[1,] -0.1761224  0.07181583 -0.02721328  0.7778622 -0.1885124 -0.1100575
[2,] -1.4880387 -1.31233190 -1.49465188 -2.1331514 -1.7774290 -1.6875679
     GSM1354095  GSM1354085 GSM1354055 GSM1354010 GSM1353959 GSM1353945
[1,] -0.3155589 -0.02251822 -0.2199418 -0.6316915 -0.3150091  -0.659194
[2,] -1.4695732 -1.64883050 -1.5376716 -0.7420860 -1.3186831  -1.722848
     GSM1353915 GSM1353913  GSM1353790 GSM1353708 GSM1353617 GSM1353581
[1,]  0.1383297 -0.4166464 -0.01854503  -0.607655  -0.416305 -0.5315652
[2,] -1.5218279 -1.5039233 -1.73553811  -1.696708  -1.685626 -1.4883369
     GSM1353530  GSM1353529 GSM1353454  GSM1353446  GSM1353443 GSM1353387
[1,] -0.3747624  0.03526839  -0.342738  0.05896598 -0.09199025  0.4106105
[2,] -1.6385804 -0.56932847  -1.570478 -1.74484228 -1.46512616 -0.4141512
     GSM1353246 GSM1353243 GSM1353209 GSM1587293  GSM1587292 GSM1587289
[1,] -0.2278424  0.1476711 -0.1491992 -0.2286116 -0.02899477 -0.3655549
[2,] -1.6013216 -1.6305151 -1.4685697 -1.9726110 -1.74372869 -1.8166832
     GSM1587288 GSM1587284 GSM1587283 GSM1587280 GSM1587279 GSM1587278
[1,] -0.4612646 -0.1891255 -0.5002931 -0.3146008 -0.7931721 -0.6981305
[2,] -1.9398235 -1.6270171 -1.7916378 -1.7534669 -1.5825265 -1.2931212
     GSM1587273 GSM1587272 GSM1587267 GSM1587266 GSM1587261  GSM1587260
[1,] -0.1699609 -0.2716296 -0.3271875 -0.3551772 -0.2691914  0.08874351
[2,] -1.5523764 -1.6672286 -1.6791546 -1.6606786 -1.2818042 -1.51893655
     GSM1204714 GSM1204712 GSM1204710 GSM1204706 GSM1625014 GSM1625013
[1,]  0.8855455   1.070178   1.064014   1.024540  0.3989349  1.7350536
[2,] -1.2795330  -1.686919  -1.413571  -1.800713 -1.1204706  0.1479403
     GSM1625012 GSM1625010 GSM1625009 GSM1625007 GSM1625006 GSM1625004
[1,]  0.7184573   1.177357   1.058108   0.478495   2.010312  0.8294897
[2,] -1.5134371  -1.375392  -1.524426  -1.035120  -1.313622 -0.9473244
     GSM1625003 GSM1625002 GSM1625000 GSM1624998 GSM1624996 GSM1624995
[1,]   1.669758  0.9017373  0.6766253  0.6761606  0.6234594  0.9979254
[2,]  -1.075758 -0.9265592 -1.0477479 -0.8140105 -1.0800480 -1.0937147
     GSM1624993
[1,]  0.4318049
[2,] -0.9855584
> 
> cr1 = cor(data.ctype.m.Nm, data.ctype.m, use="pair")
> dr1 = diag(cr1)
> summary(dr1)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.9776  0.9854  0.9871  0.9891  0.9946  0.9999 
> table(dr1 > 0.97)

TRUE 
 189 
> 
> diag(cr1) = NA
> summary(as.numeric(cr1))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
 0.8400  0.9191  0.9358  0.9361  0.9549  0.9815     189 
> ww3 = which(cr1 > 0.97, TRUE)
> dim(ww3)
[1] 2792    2
> 
> table(paste(sams.ctype$label[ww3[,1]], sams.ctype$label[ww3[,2]]))

                  B B             CD4T CD4T             CD4T CD8T 
                   24                   795                   114 
              CD4T NK             CD8T CD4T             CD8T CD8T 
                    9                   150                   389 
              CD8T NK     Monocyte Monocyte   Monocyte Neutrophil 
                   20                   934                   124 
  Neutrophil Monocyte Neutrophil Neutrophil               NK CD4T 
                   29                   162                     4 
              NK CD8T                 NK NK 
                   21                    17 
> 
> data.ctype = exp(data.ctype.m.Nm)/(1 + exp(data.ctype.m.Nm))
> 
> # ------------------------------------------------------------
> # select probes
> # ------------------------------------------------------------
> 
> utypes = unique(sams.ctype$label)
> utypes
[1] "CD4T"       "CD8T"       "Monocyte"   "B"          "NK"        
[6] "Neutrophil" "Treg"      
> length(utypes)
[1] 7
> 
> ttest <- function(v, lbs, lb1){
+   t1 = t.test(x=v[which(lbs == lb1)], y=v[which(lbs != lb1)])
+   t1$p.value
+ }
> 
> pvs = matrix(nrow=nrow(data.ctype), ncol=length(utypes))
> 
> for(j in 1:length(utypes)){
+   cat(j, date(), "\n")
+   lb1 = utypes[j]
+   pvs[,j] = apply(data.ctype, 1, ttest, lbs=sams.ctype$label, lb1=lb1)
+ }
1 Wed Feb 15 22:11:25 2017 
2 Wed Feb 15 22:12:50 2017 
3 Wed Feb 15 22:14:12 2017 
4 Wed Feb 15 22:15:36 2017 
5 Wed Feb 15 22:16:58 2017 
6 Wed Feb 15 22:18:20 2017 
7 Wed Feb 15 22:19:42 2017 
> 
> summary(pvs)
       V1                  V2                  V3                  V4          
 Min.   :0.0000000   Min.   :0.0000000   Min.   :0.0000000   Min.   :0.000000  
 1st Qu.:0.0000003   1st Qu.:0.0000000   1st Qu.:0.0000000   1st Qu.:0.001269  
 Median :0.0021002   Median :0.0002656   Median :0.0000003   Median :0.034795  
 Mean   :0.1312744   Mean   :0.1148348   Mean   :0.0804544   Mean   :0.183793  
 3rd Qu.:0.1289740   3rd Qu.:0.0799120   3rd Qu.:0.0131971   3rd Qu.:0.274970  
 Max.   :0.9999985   Max.   :0.9999872   Max.   :0.9999533   Max.   :0.999991  
       V5                  V6                  V7         
 Min.   :0.0000000   Min.   :0.0000000   Min.   :0.00000  
 1st Qu.:0.0004167   1st Qu.:0.0000000   1st Qu.:0.01899  
 Median :0.0223446   Median :0.0000266   Median :0.15268  
 Mean   :0.1714347   Mean   :0.1043391   Mean   :0.27616  
 3rd Qu.:0.2442746   3rd Qu.:0.0501618   3rd Qu.:0.48071  
 Max.   :0.9999959   Max.   :0.9999838   Max.   :1.00000  
> colSums(pvs < 0.01)
[1] 187618 207743 240513 125466 141500 220236  67202
> colSums(pvs < 1e-3)
[1] 152357 177208 217574  77385  95065 194269  38285
> colSums(pvs < 1e-4)
[1] 126259 152301 199159  50229  62735 173251  25671
> colSums(pvs < 1e-5)
[1] 105723 130397 183353  35207  40612 155024  19249
> colSums(pvs < 1e-6)
[1]  88983 110386 169379  26884  27210 139142  15328
> pcut = 0.05/nrow(info1)
> pcut
[1] 1.539191e-07
> colSums(pvs < pcut)
[1]  77766  95301 158988  22399  20797 127230  13147
> 
> pvs[match(Foxp3, info1$ID),]
             [,1]         [,2]         [,3]         [,4]         [,5]
[1,] 3.500989e-02 3.098107e-05 7.675645e-08 1.537770e-10 1.270789e-02
[2,] 8.745095e-01 3.876415e-04 3.615773e-02 3.080759e-02 2.202009e-01
[3,] 4.942751e-02 3.574854e-01 2.142557e-09 3.292977e-07 3.635084e-01
[4,] 4.103222e-19 1.180140e-09 8.274897e-37 2.004814e-02 2.135014e-02
[5,] 8.362373e-03 6.504008e-01 1.396647e-01 5.793561e-01 4.703225e-02
[6,] 6.382989e-02 7.496873e-04 1.398705e-25 1.465611e-19 1.944565e-06
[7,] 7.941956e-01 2.881917e-03 2.022617e-03 4.435909e-09 2.537537e-04
[8,] 5.066191e-02 6.128211e-01 2.253981e-01 3.095005e-07 8.080626e-02
             [,6]         [,7]
[1,] 3.478893e-01 3.779527e-03
[2,] 1.997354e-02 4.585222e-04
[3,] 1.449211e-02 3.573426e-03
[4,] 3.335288e-24 1.225692e-27
[5,] 2.554738e-01 2.559967e-05
[6,] 3.490755e-04 7.426578e-03
[7,] 8.147247e-01 2.991914e-04
[8,] 4.312815e-01 1.055134e-02
> info1[match(Foxp3, info1$ID),]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg01905377 cg01905377                   II                        
2: cg02033323 cg02033323                   II                        
3: cg04920616 cg04920616                   II                        
4: cg06767008 cg06767008                   II                        
5: cg08884343 cg08884343                   II                        
6: cg10858077 cg10858077                   II                        
7: cg15614573 cg15614573                   II                        
8: cg16350494 cg16350494                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37   X 49122718             X      49009662      R         NA
2:           37   X 49118313             X      49005257      R         NA
3:           37   X 49121288             X      49008232      R         NA
4:           37   X 49114545             X      49001489      R         NA
5:           37   X 49122423             X      49009367      R         NA
6:           37   X 49121205             X      49008149      R         NA
7:           37   X 49122364             X      49009308      F         NA
8:           37   X 49121910             X      49008854      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci       UCSC_RefGene_Name
1:            NA          NA            NA             FOXP3;FOXP3
2:            NA          NA            NA             FOXP3;FOXP3
3:            NA          NA          TRUE             FOXP3;FOXP3
4:            NA          NA            NA             FOXP3;FOXP3
5:            NA          NA          TRUE             FOXP3;FOXP3
6:            NA          NA            NA FOXP3;FOXP3;FOXP3;FOXP3
7:            NA          NA            NA             FOXP3;FOXP3
8:            NA          NA            NA             FOXP3;FOXP3
                          UCSC_RefGene_Accession          UCSC_RefGene_Group
1:                        NM_014009;NM_001114377             TSS1500;TSS1500
2:                        NM_014009;NM_001114377                 5'UTR;5'UTR
3:                        NM_014009;NM_001114377               TSS200;TSS200
4:                        NM_014009;NM_001114377                   Body;Body
5:                        NM_014009;NM_001114377             TSS1500;TSS1500
6: NM_001114377;NM_014009;NM_014009;NM_001114377 1stExon;5'UTR;1stExon;5'UTR
7:                        NM_014009;NM_001114377             TSS1500;TSS1500
8:                        NM_014009;NM_001114377             TSS1500;TSS1500
    UCSC_CpG_Islands_Name Relation_to_UCSC_CpG_Island Phantom DMR Enhancer
1: chrX:49125645-49127200                     N_Shelf                   NA
2:                                                                      NA
3:                                                                      NA
4:                                                                      NA
5: chrX:49125645-49127200                     N_Shelf                   NA
6:                                                                      NA
7: chrX:49125645-49127200                     N_Shelf                   NA
8: chrX:49125645-49127200                     N_Shelf                   NA
   HMM_Island Regulatory_Feature_Name        Regulatory_Feature_Group DHS
1:                                                                     NA
2:                                                                     NA
3:                                                                     NA
4:                X:49114410-49114805 Unclassified_Cell_type_specific  NA
5:                                                                     NA
6:                                                                     NA
7:                                                                     NA
8:                                                                     NA
   RANGE_START RANGE_END     RANGE_GB SPOT_ID
1:    49122718  49122841 NC_000023.10      NA
2:    49118313  49118436 NC_000023.10      NA
3:    49121288  49121411 NC_000023.10      NA
4:    49114545  49114668 NC_000023.10      NA
5:    49122423  49122546 NC_000023.10      NA
6:    49121205  49121328 NC_000023.10      NA
7:    49122364  49122487 NC_000023.10      NA
8:    49121910  49122033 NC_000023.10      NA
> 
> pv.min = apply(pvs, 1, min)
> summary(pv.min)
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0000000 0.0000000 0.0000000 0.0017160 0.0000022 0.7161000 
> 
> table(pv.min < pcut)

 FALSE   TRUE 
103960 220886 
> 
> dat = data.ctype[which(pv.min < pcut),]
> dim(dat)
[1] 220886    189
> dat[1:2,1:5]
     GSM861653 GSM861654 GSM861655 GSM861656 GSM861657
[1,] 0.6784794 0.6772099 0.6826744 0.6951093 0.6827040
[2,] 0.8800888 0.8513776 0.8549440 0.8795295 0.8883315
> 
> info2 = info1[which(pv.min < pcut),]
> dim(info2)
[1] 220886     31
> info2[1:2,1:5]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg00000029 cg00000029                   II                        
2: cg00000236 cg00000236                   II                        
> 
> # ------------------------------------------------------------
> # joint PCA
> # ------------------------------------------------------------
> 
> dat4Pr = dat - rowMeans(dat, na.rm=TRUE)
> 
> dat4Pr[is.na(dat4Pr)] = 0
> covdat = t(dat4Pr) %*% dat4Pr / nrow(dat4Pr)
> dim(covdat)
[1] 189 189
> prdat  = eigen(covdat)
> 
> prdat$values[1:20]
 [1] 0.726716198 0.129079197 0.117942380 0.047589254 0.046194546 0.036914182
 [7] 0.026245813 0.015229839 0.008782545 0.008466638 0.007364268 0.006352618
[13] 0.005909531 0.005259846 0.004636570 0.003840321 0.003625528 0.003352371
[19] 0.003153149 0.002954278
> 
> PC1 =  prdat$vectors[,1]
> PC2 =  prdat$vectors[,2]
> PC3 =  prdat$vectors[,3]
> 
> sams.ctype$study1 = sams.ctype$study
> table(sams.ctype$study1)

    Coit  Limbach  Reinius Reynolds  Schlums    Zhang 
      15       62       36       57       15        4 
> 
> ev = data.frame(index=1:20, eigenValue=prdat$values[1:20])
> p1 <- ggplot(ev, aes(index, eigenValue)) + geom_bar(stat = "identity")
> p1
> 
> ggsave("../figures/methylation_PCA_after_nm_eigen_values.pdf", width=9, height=6, 
+        units="in")
> 
> p2 <- ggplot(sams.ctype, aes(PC1, PC2, shape = factor(study1)))
> p2 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_PC1_vs_PC2.pdf", width=9, height=6, 
+        units="in")
> 
> p3 <- ggplot(sams.ctype, aes(PC1, PC3, shape = factor(study1)))
> p3 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_PC1_vs_PC3.pdf", width=9, height=6, 
+        units="in")
> 
> p4 <- ggplot(sams.ctype, aes(PC2, PC3, shape = factor(study1)))
> p4 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_PC2_vs_PC3.pdf", width=9, height=6, 
+        units="in")
> 
> table(sams.ctype$study, sams.ctype$label)
          
            B CD4T CD8T Monocyte Neutrophil NK Treg
  Coit      0    0    0        0         15  0    0
  Limbach   0   31   31        0          0  0    0
  Reinius   6    6    6        6          6  6    0
  Reynolds  0   23    0       34          0  0    0
  Schlums   0    0    0        0          0 15    0
  Zhang     0    0    0        0          0  0    4
> 
> # ------------------------------------------------------------
> # regress out study effect
> # ------------------------------------------------------------
> 
> datNew = dat
> 
> for(i in 1:nrow(dat)){
+   yi = dat[i,]
+   li = lm(yi ~ PC2)
+   datNew[i,] = yi - PC2*li$coef[2]
+ }
> 
> dim(datNew)
[1] 220886    189
> datNew[1:2,1:5]
     GSM861653 GSM861654 GSM861655 GSM861656 GSM861657
[1,] 0.6328456 0.6210717 0.6287278 0.6396724 0.6259747
[2,] 0.8424159 0.8050328 0.8104085 0.8337636 0.8414988
> 
> datNew[datNew < 0.001] = 0.001
> datNew[datNew > 0.999] = 0.999
> 
> dat4Pr = datNew - rowMeans(datNew, na.rm=TRUE)
> 
> dat4Pr[is.na(dat4Pr)] = 0
> covdat = t(dat4Pr) %*% dat4Pr / nrow(dat4Pr)
> dim(covdat)
[1] 189 189
> prdat  = eigen(covdat)
> 
> prdat$values[1:20]
 [1] 0.725774158 0.115269404 0.048122175 0.046251142 0.036953813 0.026040492
 [7] 0.015012588 0.008840331 0.008474925 0.007366138 0.006348560 0.005888165
[13] 0.005310723 0.004639009 0.003849266 0.003621270 0.003352999 0.003147994
[19] 0.002997130 0.002725879
> 
> PC1 =  prdat$vectors[,1]
> PC2 =  prdat$vectors[,2]
> PC3 =  prdat$vectors[,3]
> 
> sams.ctype$study1 = sams.ctype$study
> table(sams.ctype$study1)

    Coit  Limbach  Reinius Reynolds  Schlums    Zhang 
      15       62       36       57       15        4 
> 
> ev = data.frame(index=1:20, eigenValue=prdat$values[1:20])
> p1 <- ggplot(ev, aes(index, eigenValue)) + geom_bar(stat = "identity")
> p1
> 
> ggsave("../figures/methylation_PCA_after_nm_rmPC2_eigen_values.pdf", 
+        width=7.5, height=5, units="in")
> 
> p2 <- ggplot(sams.ctype, aes(PC1, PC2, shape = factor(study1)))
> p2 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_rmPC2_PC1_vs_PC2.pdf", 
+        width=7.5, height=5, units="in")
> 
> p3 <- ggplot(sams.ctype, aes(PC1, PC3, shape = factor(study1)))
> p3 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_rmPC2_PC1_vs_PC3.pdf", 
+        width=7.5, height=5, units="in")
> 
> p4 <- ggplot(sams.ctype, aes(PC2, PC3, shape = factor(study1)))
> p4 + geom_point(aes(colour = factor(label)), size = 4) +
+   geom_point(colour = "grey90", size = 1.5)
> 
> ggsave("../figures/methylation_PCA_after_nm_rmPC2_PC2_vs_PC3.pdf", 
+        width=7.5, height=5, units="in")
> 
> table(sams.ctype$study, sams.ctype$label)
          
            B CD4T CD8T Monocyte Neutrophil NK Treg
  Coit      0    0    0        0         15  0    0
  Limbach   0   31   31        0          0  0    0
  Reinius   6    6    6        6          6  6    0
  Reynolds  0   23    0       34          0  0    0
  Schlums   0    0    0        0          0 15    0
  Zhang     0    0    0        0          0  0    4
> 
> # ------------------------------------------------------------
> # write out data
> # ------------------------------------------------------------
> 
> setwd("~/research/Deconvolution/data")
> 
> dat = round(dat, 7)
> datNew = round(datNew, 7)
> 
> dim(dat)
[1] 220886    189
> dat[1:2,1:5]
     GSM861653 GSM861654 GSM861655 GSM861656 GSM861657
[1,] 0.6784794 0.6772099 0.6826744 0.6951093 0.6827040
[2,] 0.8800888 0.8513776 0.8549440 0.8795295 0.8883315
> 
> dim(datNew)
[1] 220886    189
> datNew[1:2,1:5]
     GSM861653 GSM861654 GSM861655 GSM861656 GSM861657
[1,] 0.6328456 0.6210717 0.6287278 0.6396724 0.6259747
[2,] 0.8424159 0.8050328 0.8104085 0.8337636 0.8414988
> 
> dim(info2)
[1] 220886     31
> info2[1:2,]
           ID       Name Infinium_Design_Type Next_Base Color_Channel
1: cg00000029 cg00000029                   II                        
2: cg00000236 cg00000236                   II                        
   Genome_Build CHR  MAPINFO Chromosome_36 Coordinate_36 Strand Probe_SNPs
1:           37  16 53468112            16      52025613      F         NA
2:           37   8 42263294             8      42382451      R         NA
   Probe_SNPs_10 Random_Loci Methyl27_Loci UCSC_RefGene_Name
1:            NA          NA            NA              RBL2
2:            NA          NA            NA       VDAC3;VDAC3
   UCSC_RefGene_Accession UCSC_RefGene_Group   UCSC_CpG_Islands_Name
1:              NM_005611            TSS1500 chr16:53468284-53469209
2: NM_005662;NM_001135694        3'UTR;3'UTR                        
   Relation_to_UCSC_CpG_Island Phantom DMR Enhancer HMM_Island
1:                     N_Shore                   NA           
2:                                               NA           
   Regulatory_Feature_Name Regulatory_Feature_Group  DHS RANGE_START RANGE_END
1:    16:53467838-53469685      Promoter_Associated TRUE    53468112  53468235
2:                                                    NA    42263294  42263417
       RANGE_GB SPOT_ID
1:  NC_000016.9      NA
2: NC_000008.10      NA
> 
> dim(sams.ctype)
[1] 189   4
> sams.ctype[1:2,]
          id label   study  study1
1: GSM861653  CD4T Reinius Reinius
2: GSM861654  CD4T Reinius Reinius
> 
> sams.ctype = sams.ctype[,1:3, with=FALSE]
> dim(sams.ctype)
[1] 189   3
> sams.ctype[1:2,]
          id label   study
1: GSM861653  CD4T Reinius
2: GSM861654  CD4T Reinius
> 
> write.table(dat, file = "methylation_pure_ct_data.txt", append = FALSE,
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> write.table(datNew, file = "methylation_pure_ct_rmPC2_data.txt", append = FALSE,
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> write.table(sams.ctype, file = "methylation_pure_ct_sample.txt", append = FALSE,
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> write.table(info2, file = "methylation_pure_ct_info.txt", append = FALSE, 
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> 
> quit(save="no")
> proc.time()
    user   system  elapsed 
2270.388   81.256 2370.687 
