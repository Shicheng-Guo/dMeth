---
output:
  pdf_document: default
  html_document: default
---

```{r}

library(data.table)
library(ggplot2)
library(ggpubr)
library(ggpointdensity)
theme_set(theme_bw())

# ------------------------------------------------------------------------
# load results of deconvolution
# ------------------------------------------------------------------------

load("deconv_expr_COAD.RData")
ls()

load("deconv_methy_COAD.RData")
ls()

dim(deconv_expr_COAD)
dim(rho_COAD)

deconv_expr_COAD[1:2,]
rho_COAD[1,,]

dimnames(rho_COAD)

table(rownames(deconv_expr_COAD) == dimnames(rho_COAD)[[1]])
cor(deconv_expr_COAD[,"B"], rho_COAD[,"B","OriEM"])

# ------------------------------------------------------------------------
# load results of clinical information
# ------------------------------------------------------------------------

sc = readRDS("clinical_data/COAD_somatic_clinic.rds")
dim(sc)
names(sc)

sc = sc[,-(23:32)]
dim(sc)
sc[1:2,]

emInfo = fread("clinical_data/patient_coad_M_info_hyperMeth.txt")
dim(emInfo)
emInfo[1, ]

table(emInfo$bcr_patient_barcode %in% sc$barcode)
names(emInfo)[which(names(emInfo)=="bcr_patient_barcode")] = "barcode"

emInfo = merge(emInfo, sc, by="barcode")
dim(emInfo)

# ------------------------------------------------------------------------
# merage clinical information and cell type composition estimates
# ------------------------------------------------------------------------

colnames(deconv_expr_COAD) = paste0(colnames(deconv_expr_COAD), ".E")

ct = data.frame(deconv_expr_COAD, rho_COAD[,,"OriEM"])
dim(ct)
ct[1:2,]

table(rownames(ct) %in% emInfo$patient_id)

ct$patient_id = rownames(ct)
ct = merge(ct, emInfo, by="patient_id")
dim(ct)
ct[1:2,]

names(ct)

g1 = ggplot(ct, aes(x=B.E, y=B)) + geom_point() +
  geom_abline(intercept=0, slope=1)

g2 = ggplot(ct, aes(x=CD8T.E, y=CD8T)) + geom_point() +
  geom_abline(intercept=0, slope=1)

g3 = ggplot(ct, aes(x=Monocyte.E, y=Monocyte)) + geom_point() +
  geom_abline(intercept=0, slope=1)

ggarrange(g1, g2, g3, nrow = 1, ncol = 3)

ggplot(ct, aes(x=log10(raw_MB_hg38_SNV)))+
  geom_histogram(color="darkblue", fill="lightblue")  +
  geom_vline(xintercept = log10(400))

ct$hyper_mutation = ct[,"raw_MB_hg38_SNV"] > 400

g1 = ggplot(ct, aes(x=hyper_mutation, y=B.E)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

g2 = ggplot(ct, aes(x=hyper_mutation, y=B)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

g3 = ggplot(ct, aes(x=hyper_mutation, y=CD8T.E)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

g4 = ggplot(ct, aes(x=hyper_mutation, y=CD8T)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

g5 = ggplot(ct, aes(x=hyper_mutation, y=Monocyte.E)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

g6 = ggplot(ct, aes(x=hyper_mutation, y=Monocyte)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(shape=16, position=position_jitter(0.2))

ggarrange(g1, g2, g3, g4, g5, g6, nrow = 3, ncol = 2)

wilcox.test(ct$CD8T~ ct$hyper_mutation)
wilcox.test(ct$CD8T.E~ ct$hyper_mutation)

```
