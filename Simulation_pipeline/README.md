# Simulation  Study

After generating a cell type specific reference data in cell_type_specific_reference, one could repeat our combined simulation study. This pipeline also requires the following packages:
nnls
data.table
MASS
quadprog
ggplot2
e1071

This pipeline include four steps. 

## step1 - GetMethylationMatrix.R

### 1.Read cell type specific methylation data. The following files are required:

methylation_pure_ct_rmPC2_data.txt:     Pure cell type data file after removing PC2
methylation_pure_ct_sample.txt:	        Pure cell type sample file
methylation_pure_ct_info.txt:		Pure cell type information file, of the selected probes

and a different methylation data file:
methylation_betaValue.txt
methylation_info.txt

take intersections of common CpG sites in two source of data and create the dataset with 189 samples of cell type-specific DNA methylation data.

### 2. Split this data set into two parts: one for generating reference data, one fore generating pseudo mixtures.

### 3. read in methylation sample information.

"patient_coad_short_table_nMut.txt"
"patient_coad_M_info_hyperMeth.txt"

### 4. filter CpG to use.
Filter differentiatly methylated CpG sites, p-value threshold equals 0.01. Around 1000 CpGs are selected.

## step2 - EstimatingMethylation.R

1. Estimate mean and variance for each probe
2. Remove CpGs with NA entries
3. Further select probes by checking residuals. Regress each cell type methylation on all other cell types, remove CpG's with small residuals to eliminate collinearity.

## step3- Simulation.R

functions to generate simulation data from mixture model and run different algorithms:

### gen_methy_beta: generating pseudo mixtures given experiment setting parameters:

parameters:

* mu = reference data
* alpha = expected mean of proportion of each cell type
* sample.size = size of sample
* pi = average proportion of inconsistent CpGs in each sample
* cellnum = approximately number of cells in the bulk tissue, 1/cellnum is set to be sigma_c^2
* noise = ratio between aberrant CpGs and consistent CpGs
	
It returns a list of the following components:

* bulk_sample = a matrix of size K*N, K=number of CpGs, N= number of samples.
* mix = true proportion of each cell type
* V = variance 
* eta = proportion of unknown cell type, generated by uniform distribution
* nu0 = generated methylation for unknown cell type
* idic = an indicator of whether a CpG is consistent or aberrant

### runsim: main function to run a setting of simulation

parameters:
* simsize = sample size
* simnoise = ratio between aberrant CpGs and consistent CpGs
* simpi = average proportion of inconsistent CpGs in each sample
* aber = BOOL: whether or not to have the unknown cell type
* penalty = parameter for ridge penalty
* cellnum = approximately number of cells in the bulk tissue, 1/cellnum is set to be sigma_c^2
* maxiter = maximum iteration time of EM
	
It returns a list of the following components:

* rho = estimated proportion
* err = square root of mean square error
* cor = correlation between rho and true label
* laplace = all outputs from emeth with laplace likelihood
* ori = all outputs from emeth with normal likelihood
* true = the sample generated in this run of simulation
* nu0cor = correlation between estimated nu0 and true nu0
	
	
## step4 - batchsim.R

script to generate experiments with repetitions under different settings.
Generate a string "setting" to indicate the experiment settings
Create the following files:

* rho_setting.RData: estimation result in one repetition
* err_setting.RData: rooted mean square error for each repetition for each cell type
* cor_setting.RData: correlation between rho and true label for each cell type in each repetition
* nu0_setting.RData: correlation between estimated nu0 and true nu0
* nu0_setting.pdf: the scatter plot of estimated nu0 and true nu0
* rho_setting.pdf: the scatter plot between true proportion and estimated proportion
* error_setting.pdf: the box plot of RMSE for each cell type 

